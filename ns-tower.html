<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
  <title>NS-Tower</title>
  <style>
    html, body {
      width: 100vw;
      height: 100vh;
      margin: 0;
      padding: 0;
      overflow: hidden;
      background: black;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      min-width: 100vw;
      justify-content: flex-start;
      align-items: center;
    }
    body {
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      min-width: 100vw;
      justify-content: flex-start;
      align-items: center;
      background: black;
    }
    canvas {
      display: block;
      margin: 0 auto;
      background: #002244;
    }
    #hud {
      width: 100vw;
      max-width: 480px;
      margin: 0 auto;
      color: #fff;
      font-family: 'Arial Black', Arial, 'Microsoft JhengHei', sans-serif;
      font-size: 18px;
      letter-spacing: 1px;
      user-select: none;
      background: #111;
      box-shadow: 0 2px 8px #000a;
      height: 48px;
      line-height: 1.1;
      display: flex;
      flex-direction: row;
      align-items: center;
      justify-content: space-between;
      box-sizing: border-box;
      padding: 0 18px 0 18px;
      white-space: nowrap;
      overflow: visible;
      position: relative;
      margin-top: 0;
      margin-bottom: 0;
      z-index: 10;
    }
    #hud .power-block {
      order: 0;
      margin-left: 8px;
    }
    #hud .hud-score {
      order: 1;
      position: static;
      left: unset;
      transform: none;
      z-index: 2;
      pointer-events: none;
      text-align: center;
      color: #c5e665 !important;
      font-size: 38px !important;
      font-family: 'Arial Black', Arial, 'Microsoft JhengHei', sans-serif;
      text-shadow: 2px 2px 0 #000, 0 0 8px #000, 0 0 2px #fff;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 100%;
      margin-left: 0;
      margin-right: 0;
      flex: 1;
    }
    #hud .hud-score .score-num {
      font-size: 38px;
      font-family: 'Arial Black', Arial, 'Microsoft JhengHei', sans-serif;
      color: #c5e665 !important;
      font-style: italic;
      text-shadow: 2px 2px 0 #000, 0 0 8px #000, 0 0 2px #fff;
      letter-spacing: 2px;
    }
    #hud .hud-score .score-unit {
      font-size: 22px;
      color: #c5e665 !important;
      font-family: 'Arial Black', Arial, 'Microsoft JhengHei', sans-serif;
      font-style: italic;
      margin-left: 2px;
      text-shadow: 2px 2px 0 #000, 0 0 8px #000, 0 0 2px #fff;
    }
    #hud-center span {
      line-height: 1.1 !important;
    }
    #hud-audio-panel button {
      font-size: 0.8rem !important;
      padding: 1px 4px !important;
      border-radius: 7px !important;
      margin-bottom: 1px;
      min-width: 0;
      max-width: 90px;
      box-sizing: border-box;
    }
    #hud-audio-panel {
      order: 2;
      gap: 2px !important;
      max-width: 100px;
    }
    .power-block {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      justify-content: flex-end;
      margin-right: 18px;
    }
    .power-label {
      font-size: 20px;
      font-family: 'Arial Black', Arial, 'Microsoft JhengHei', sans-serif;
      font-style: italic;
      color: #3af;
      text-shadow: 1px 1px 0 #fff, 2px 2px 0 #000, 0 0 8px #000;
      margin-right: 0;
      margin-bottom: 0;
      letter-spacing: 1px;
      margin-left: 2px;
      margin-bottom: 2px;
    }
    #controls {
      width: 95vw;
      max-width: 420px;
      display: flex;
      justify-content: space-between;
      margin: 0 auto;
      gap: 16px;
      user-select: none;
      position: fixed;
      left: 50%;
      bottom: 0;
      transform: translateX(-50%);
      z-index: 10;
      background: rgba(0,0,0,0.7);
      padding: 8px 0 8px 0;
      border-radius: 16px 16px 0 0;
    }
    .ctrl-btn {
      flex: 1;
      height: 48px;
      font-size: 2rem;
      background: #222;
      color: #fff;
      border: 2px solid #888;
      border-radius: 12px;
      margin: 0 8px;
      box-shadow: 0 2px 8px #0008;
      transition: background 0.2s;
      touch-action: manipulation;
    }
    .ctrl-btn:active {
      background: #444;
    }
    #game {
      width: 100vw;
      max-width: 480px;
      height: 90vh;
      max-height: 100vh;
      background: #002244;
      display: block;
      margin: 0 auto;
      touch-action: none;
      /* padding-bottom ç”± JS å‹•æ…‹èª¿æ•´ï¼Œç¢ºä¿ä¸èˆ‡åº•éƒ¨æŒ‰éˆ•é‡ç–Š */
    }
    @media (max-width: 600px) {
      #hud {
        font-size: 12px;
        height: auto;
        line-height: 1.1;
        padding: 2px 0 2px 0;
        margin-top: 2px;
        margin-bottom: 2px;
      }
      .ctrl-btn {
        height: 40px;
        font-size: 1.5rem;
      }
      #game {
        height: 90vh;
        max-height: 100vh;
        /* padding-bottom ç”± JS å‹•æ…‹èª¿æ•´ */
      }
      #hud .hud-score {
        font-size: 28px !important;
      }
      #hud-center span {
        font-size: 11px !important;
      }
      #hud .hud-power {
        height: 10px !important;
      }
      #hud-audio-panel {
        flex-direction: row !important;
        gap: 2px !important;
        max-width: 100vw;
      }
      #hud-audio-panel button {
        font-size: 0.7rem !important;
        padding: 0 2px !important;
        border-radius: 6px !important;
        min-width: 0;
        max-width: 48vw;
      }
    }
    #hud .power-block, #hud #hud-audio-panel {
      z-index: 3;
    }
    #bottom-controls {
      position: fixed;
      left: 50%;
      bottom: 0;
      transform: translateX(-50%);
      display: flex;
      flex-direction: row;
      align-items: center;
      gap: 4px;
      z-index: 100;
      width: 100vw;
      max-width: 480px;
      justify-content: center;
      padding: 4px 0 4px 0;
      background: rgba(0,0,0,0.7);
      border-radius: 16px 16px 0 0;
      flex-wrap: nowrap;
    }
    #bottom-controls button {
      font-size: 0.7rem !important;
      padding: 1px 3px !important;
      border-radius: 7px !important;
      min-width: 0;
      max-width: 70px;
      height: 28px;
      line-height: 1.1;
      box-sizing: border-box;
      white-space: nowrap;
    }
    #bottom-controls #pause-toggle {
      max-width: 80px;
      padding: 1px 8px !important;
    }
    #shoe-item-toggle {
      min-width: 160px;
    }
    @media (max-width: 600px) {
      #bottom-controls {
        gap: 1px;
        max-width: 100vw;
        padding: 2px 0 2px 0;
      }
      #bottom-controls button {
        font-size: 0.65rem !important;
        padding: 0 1px !important;
        border-radius: 6px !important;
        max-width: 28vw;
        height: 22px;
      }
      #bottom-controls #pause-toggle {
        max-width: 32vw;
        padding: 0 4px !important;
      }
    }
    #hud .hud-highscore {
      order: 2;
      margin-right: 12px;
      color: #c5e665;
      font-size: 20px;
      font-family: 'Arial Black', Arial, 'Microsoft JhengHei', sans-serif;
      text-shadow: 1px 1px 0 #000, 0 0 4px #000, 0 0 1px #fff;
      white-space: nowrap;
      min-width: 80px;
      text-align: right;
    }
  </style>
</head>
<body>
<audio id="sfx-jump" src="Data_2.wav" preload="auto"></audio>
<audio id="sfx-dead" src="Data_6.wav" preload="auto"></audio>
<audio id="bgm" src="bgm1.mp3" preload="auto" loop></audio>
<audio id="sfx-land" src="Data_1.wav" preload="auto"></audio>
<audio id="sfx-spring-jump" src="Data_3.wav" preload="auto"></audio>
<audio id="sfx-charge" src="Data_7.wav" preload="auto"></audio>
<div id="hud">
  <span class="power-block">
    <span class="power-label">POWER</span>
    <span class="hud-power"></span>
  </span>
  <span class="hud-score" id="hud-score"></span>
  <span class="hud-highscore" id="hud-highscore"></span>
</div>
<!-- æ–°å¢åº•éƒ¨æ§åˆ¶å€ -->
<div id="bottom-controls">
  <button id="pause-toggle" type="button">â¸ï¸ æš«åœ</button>
  <button id="sfx-toggle" type="button">ğŸ”Š éŸ³æ•ˆ</button>
  <button id="bgm-toggle" type="button">ğŸµ éŸ³æ¨‚</button>
  <button id="settings-toggle" type="button">âš™ï¸ è¨­å®š</button>
  <button id="help-toggle" type="button">â“ èªªæ˜</button>
  <button id="about-toggle" type="button">â„¹ï¸ é—œæ–¼</button>
</div>
<canvas id="game"></canvas>
<div id="gameover-modal" style="display:none;position:fixed;z-index:1000;left:0;top:0;width:100vw;height:100vh;background:rgba(0,0,0,0.7);align-items:center;justify-content:center;flex-direction:column;">
  <div style="background:#222;padding:32px 24px 24px 24px;border-radius:18px;box-shadow:0 4px 24px #000a;max-width:90vw;text-align:center;user-select:none;">
    <div id="gameover-msg" style="color:#fff;font-size:1.5rem;margin-bottom:18px;user-select:none;"></div>
    <button id="restart-btn" style="font-size:1.2rem;padding:10px 32px;background:#ff0;color:#222;border:none;border-radius:8px;box-shadow:0 2px 8px #0008;font-weight:bold;user-select:none;">é‡æ–°é–‹å§‹</button>
  </div>
</div>

<!-- æ“ä½œèªªæ˜å½ˆçª— -->
<div id="help-modal" style="display:none;position:fixed;z-index:2000;left:0;top:0;width:100vw;height:100vh;background:rgba(0,0,0,0.7);align-items:center;justify-content:center;flex-direction:column;">
  <div style="background:#222;padding:28px 18px 18px 18px;border-radius:16px;box-shadow:0 4px 24px #000a;max-width:90vw;text-align:left;user-select:none;min-width:260px;">
    <div style="color:#ffe600;font-size:1.3rem;margin-bottom:12px;font-weight:bold;">NS-Tower æ“ä½œèªªæ˜</div>
    <div style="color:#fff;font-size:1rem;line-height:1.7;">
      <b>éŠæˆ²ç›®æ¨™ï¼š</b>æ“æ§è§’è‰²ä¸æ–·å¾€ä¸Šè·³ï¼ŒæŒ‘æˆ°æ›´é«˜æ¨“å±¤åˆ†æ•¸ï¼<br><br>
      <b>æ“ä½œæ–¹å¼ï¼š</b><br>
      â— <b>æŒ‰ä½è¢å¹•</b> æˆ– <b>ç©ºç™½éµ</b> è“„åŠ›ï¼Œæ”¾é–‹å³å¯è·³èºã€‚<br>
      â— è§’è‰²æœƒè‡ªå‹•å·¦å³è¡Œèµ°ï¼Œé‡åˆ°ç‰†å£è‡ªå‹•åå‘ã€‚<br>
      â— è·³åˆ°ä¸åŒå¹³å°æœƒæœ‰ç‰¹æ®Šæ•ˆæœï¼ˆå½ˆç°§ã€è¼¸é€å¸¶ç­‰ï¼‰ã€‚<br>
      â— åƒåˆ°é›è…¿é“å…·å¯ç²å¾—çŸ­æš«é«˜è·³èƒ½åŠ›ã€‚<br>
      â— åƒåˆ°è—¥ä¸¸é“å…·æœƒå·¨å¤§åŒ–ä¸¦è·³æ›´é«˜ï¼ŒæŒçºŒ10ç§’ã€‚<br>
    </div>
    <div style="text-align:center;margin-top:18px;">
      <button id="help-close-btn" style="font-size:1rem;padding:6px 32px;background:#ffe600;color:#222;border:none;border-radius:8px;box-shadow:0 2px 8px #0008;font-weight:bold;">é—œé–‰</button>
    </div>
  </div>
</div>
<!-- éŠæˆ²è¨­å®šå½ˆçª— -->
<div id="settings-modal" style="display:none;position:fixed;z-index:2100;left:0;top:0;width:100vw;height:100vh;background:rgba(0,0,0,0.7);align-items:center;justify-content:center;flex-direction:column;">
  <div style="background:#222;padding:28px 18px 18px 18px;border-radius:16px;box-shadow:0 4px 24px #000a;max-width:90vw;text-align:left;user-select:none;min-width:260px;">
    <div style="color:#ffe600;font-size:1.3rem;margin-bottom:12px;font-weight:bold;">éŠæˆ²è¨­å®š</div>
    <div style="color:#fff;font-size:1rem;line-height:2;">
      <label style="display:block;margin-bottom:8px;">
        <span style="margin-right:8px;">åŠ›é‡é‡ç½®ï¼š</span>
        <button id="settings-power-reset" type="button"></button>
      </label>
      <label style="display:block;margin-bottom:8px;">
        <span style="margin-right:8px;">è¡Œèµ°é€Ÿåº¦ï¼š</span>
        <div style="display:inline-flex;gap:4px;">
          <button id="settings-walk-slow" type="button" style="padding:4px 8px;border-radius:4px;border:1px solid #666;background:#333;color:#fff;font-size:0.9rem;">æ…¢</button>
          <button id="settings-walk-normal" type="button" style="padding:4px 8px;border-radius:4px;border:1px solid #666;background:#333;color:#fff;font-size:0.9rem;">ä¸­</button>
          <button id="settings-walk-fast" type="button" style="padding:4px 8px;border-radius:4px;border:1px solid #666;background:#333;color:#fff;font-size:0.9rem;">å¿«</button>
        </div>
      </label>
      <label style="display:block;margin-bottom:8px;">
        <span style="margin-right:8px;">éŠæˆ²é€Ÿåº¦ï¼š</span>
        <div style="display:flex;align-items:center;gap:8px;margin-top:4px;">
          <span style="font-size:0.8rem;color:#ccc;">æ…¢</span>
          <button id="speed-decrease" type="button" style="width:32px;height:32px;border-radius:50%;border:2px solid #666;background:#333;color:#fff;font-size:1.2rem;font-weight:bold;cursor:pointer;">-</button>
          <div style="flex:1;height:20px;background:#333;border-radius:10px;border:1px solid #666;position:relative;display:flex;align-items:center;justify-content:center;">
            <div id="speed-display" style="font-size:0.9rem;color:#ffe600;font-weight:bold;">0</div>
          </div>
          <button id="speed-increase" type="button" style="width:32px;height:32px;border-radius:50%;border:2px solid #666;background:#333;color:#fff;font-size:1.2rem;font-weight:bold;cursor:pointer;">+</button>
          <span style="font-size:0.8rem;color:#ccc;">å¿«</span>
        </div>
      </label>
      <label style="display:block;margin-bottom:8px;">
        <span style="margin-right:8px;">é“å…·ï¼š</span>
        <button id="settings-shoe-item" type="button"></button>
      </label>
    </div>
    <div style="text-align:center;margin-top:18px;">
      <button id="settings-close-btn" style="font-size:1rem;padding:6px 32px;background:#ffe600;color:#222;border:none;border-radius:8px;box-shadow:0 2px 8px #0008;font-weight:bold;">é—œé–‰</button>
    </div>
  </div>
</div>
<!-- é—œæ–¼å½ˆçª— -->
<div id="about-modal" style="display:none;position:fixed;z-index:2200;left:0;top:0;width:100vw;height:100vh;background:rgba(0,0,0,0.7);align-items:center;justify-content:center;flex-direction:column;">
  <div style="background:#222;padding:28px 18px 18px 18px;border-radius:16px;box-shadow:0 4px 24px #000a;max-width:90vw;text-align:left;user-select:none;min-width:260px;">
    <div style="color:#ffe600;font-size:1.3rem;margin-bottom:12px;font-weight:bold;">é—œæ–¼ NS-Tower æ”¹ç·¨ç‰ˆ</div>
    <div style="color:#fff;font-size:1rem;line-height:1.7;">
      <b>éŠæˆ²ç‰ˆæœ¬ï¼š</b>2.0<br>
      <b>éŠæˆ²é¡å‹ï¼š</b>å¹³å°è·³èº<br>
      <b>é–‹ç™¼èªè¨€ï¼š</b>HTML5 + JavaScript<br>
      <br>
      <b>æ„Ÿè¬æ”¯æŒï¼š</b><br>
      ä¸­åœ‹ä¿¡è¨—å¸³æˆ¶ éŠ€è¡Œä»£ç¢¼822<br>
      159540291165 æˆ¶åï¼šå¼µæ›¸ç¶­<br>
      <br>
      <b>è¯çµ¡æ–¹å¼ï¼š</b><br>
      ä½œè€…Lineï¼šgame76420<br>
      <br>
      <b>ç‰ˆæ¬Šè²æ˜ï¼š</b><br>
      Â© 2024 å¼µæ›¸ç¶­. ä¿ç•™æ‰€æœ‰æ¬Šåˆ©ã€‚
    </div>
    <div style="text-align:center;margin-top:18px;">
      <button id="about-close-btn" style="font-size:1rem;padding:6px 32px;background:#ffe600;color:#222;border:none;border-radius:8px;box-shadow:0 2px 8px #0008;font-weight:bold;">é—œé–‰</button>
    </div>
  </div>
</div>
<script>
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");

function resizeCanvas() {
  const ratio = window.devicePixelRatio || 1;
  const w = Math.min(window.innerWidth, 480);
  // å‹•æ…‹å–å¾—åº•éƒ¨æŒ‰éˆ•é«˜åº¦
  const bottomControls = document.getElementById('bottom-controls');
  let bottomPad = 0;
  if (bottomControls) {
    bottomPad = bottomControls.offsetHeight || 0;
  }
  // é ç•™åœ°é¢å¹³å°é«˜åº¦ï¼Œç¢ºä¿åœ°é¢å®Œæ•´éœ²å‡º
  const minH = 120;
  // æ¸›å»åº•éƒ¨æŒ‰éˆ•é«˜åº¦
  const h = Math.max(Math.min(window.innerHeight * 0.92, 720), minH) + 16 - bottomPad;
  canvas.style.width = w + 'px';
  canvas.style.height = h + 'px';
  canvas.width = w * ratio;
  canvas.height = h * ratio;
  ctx.setTransform(1, 0, 0, 1, 0, 0);
  ctx.scale(ratio, ratio);
  // å‹•æ…‹è¨­ç½® padding-bottomï¼Œç¢ºä¿åœ°é¢ä¸è¢«æ“‹ä½
  canvas.style.paddingBottom = bottomPad + 'px';
}
window.addEventListener('resize', resizeCanvas);
resizeCanvas();

function getWidth() {
  return canvas.width / (window.devicePixelRatio || 1);
}
function getHeight() {
  return canvas.height / (window.devicePixelRatio || 1);
}

// éŠæˆ²åƒæ•¸
let player, stairs, gameSpeed, stairGap, stairWidth, stairHeight, score, highScore, paused, animationFrameId, direction, jumpPending, bgmMuted, sfxMuted, firstInteraction;
let lastStair = null;
let platformSet = new Set();
let firstPlatformPassed = false;
let platformPassedCount = 0; // å·²ä¸å†ä½¿ç”¨
let lastLandedStair = null; // å·²ä¸å†ä½¿ç”¨
let passedPlatforms = new Set(); // æœ¬è¼ªè¨ˆåˆ†ç”¨
let allPassedPlatforms = new Set(); // éŠæˆ²æœŸé–“æ‰€æœ‰å·²è¨ˆç®—éçš„å¹³å°Y
// æ–°å¢ï¼šè¦–è§’æ‹‰å‹• flag
let needScrollToStair = false;
let lastLandedStairY = null;
// æ–°å¢ï¼šé¡é ­åç§»
let cameraOffsetY = 0;
let cameraTargetOffsetY = 0;
// åœ¨å…¨åŸŸè®Šæ•¸å€åŠ ï¼š
let lastDifficultyScore = 0;
// æ–°å¢ï¼šåŠ›é‡é‡ç½®é–‹é—œ
let powerAutoReset = false;
// æ–°å¢ï¼šè¼¸å…¥ç‹€æ…‹ç®¡ç†
let inputState = { isPressed: false, spacebar: false };
// æ–°å¢ï¼šè½åœ°ç·©è¡ï¼ˆjump bufferï¼‰
let jumpBufferTimer = 0;
const JUMP_BUFFER_TIME = 0.2; // ç§’
// æ–°å¢ï¼šé‹å‹•é‹buffç‹€æ…‹
let shoeBuffActive = false;
let shoeBuffEndTime = 0;
// æ–°å¢ï¼šé‹å‹•é‹é“å…·é–‹é—œ
let shoeItemEnabled = true;
// æ–°å¢ï¼šæ¨“æ¢¯Xè»¸åˆ†å¸ƒæ§åˆ¶
let recentStairPositions = []; // è¨˜éŒ„æœ€è¿‘å¹¾å€‹æ¨“æ¢¯çš„Xä½ç½®
const MAX_RECENT_POSITIONS = 5; // è¨˜éŒ„æœ€è¿‘5å€‹æ¨“æ¢¯ä½ç½®
// æ–°å¢ï¼šè† å›Šç¸®æ”¾å‹•ç•«
let pillScale = 1;
let pillScaleTarget = 1;
let pillScaleAnimStartTime = 0;
const PILL_ANIM_DURATION = 350; // ms
// æ–°å¢ï¼šå‰6å€‹ç‰¹æ®Šæ¨“æ¢¯é¡å‹éš¨æ©Ÿæ‰“äº‚
let stairTypeShuffle = [];
let stairTypeShuffleIdx = 0;
// æ–°å¢ï¼šæ¨“æ¢¯Xä½ç½®å¾ªç’°æ¨¡å¼
const stairXPattern = ['left', 'random', 'right', 'random'];
let stairXPatternIdx = 0;
// æ–°å¢ï¼šéŠæˆ²é€Ÿåº¦æ»‘æ¡¿è¨­å®š
let gameSpeedMultiplier = 0; // -50 åˆ° 50ï¼Œå½±éŸ¿æ•´é«”éŠæˆ²é€Ÿåº¦

// æ–°å¢ï¼šæ¯å››å€‹ä¸€çµ„å¿…æœ‰ä¸€å·¦ä¸€å³å…©éš¨æ©Ÿ
let nextStairGroup = [];
function shuffleArray(arr) {
  for (let i = arr.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [arr[i], arr[j]] = [arr[j], arr[i]];
  }
  return arr;
}

function generateSmartStairPositionV5(canvasWidth, stairWidth, platformType) {
  // æ°´å¹³ç§»å‹•å¹³å°ï¼šå®Œå…¨éš¨æ©Ÿï¼Œä¸å½±éŸ¿ä¸»åºåˆ—
  if (platformType === 'horizontal') {
    return Math.random() * (canvasWidth - stairWidth);
  }

  // æ¯å››å€‹ä¸€çµ„ï¼Œå¿…æœ‰ä¸€å·¦ä¸€å³å…©éš¨æ©Ÿï¼Œé †åºéš¨æ©Ÿ
  if (nextStairGroup.length === 0) {
    nextStairGroup = ['left', 'right', 'random', 'random'];
    shuffleArray(nextStairGroup);
  }
  const type = nextStairGroup.shift();
  if (type === 'left') return 0;
  if (type === 'right') return canvasWidth - stairWidth;
  // random
  return Math.random() * (canvasWidth - stairWidth);
}

// éŸ³æ•ˆ
const sfxJump = document.getElementById('sfx-jump');
const sfxDead = document.getElementById('sfx-dead');
const bgm = document.getElementById('bgm');
const sfxLand = document.getElementById('sfx-land');
const sfxSpringJump = document.getElementById('sfx-spring-jump');
const sfxCharge = document.getElementById('sfx-charge');

// éŸ³æ•ˆéœéŸ³ç‹€æ…‹
sfxMuted = false;
bgmMuted = true;
firstInteraction = false;

if (localStorage.getItem('ns_tower_highscore')) {
  highScore = parseInt(localStorage.getItem('ns_tower_highscore')) || 0;
} else {
  highScore = 0;
}

function playSfx(audio) {
  if (!audio || sfxMuted) return;
  audio.currentTime = 0;
  audio.muted = sfxMuted;
  audio.play();
}
function tryPlayBgm() {
  if (bgm.paused && !bgmMuted) {
    bgm.volume = 0.5;
    bgm.play().catch(()=>{});
  }
}

// æ–°å¢ï¼šè¡Œèµ°é€Ÿåº¦æ¨¡å¼
let walkSpeedMode = 'normal'; // 'slow' | 'normal' | 'fast'
const walkSpeedMap = { slow: 1.2, normal: 2.2, fast: 3.2 };

// è¨ˆç®—æœ€çµ‚è¡Œèµ°é€Ÿåº¦ï¼ˆçµåˆæ¨¡å¼é¸æ“‡å’ŒéŠæˆ²é€Ÿåº¦èª¿æ•´ï¼‰
function getFinalWalkSpeed() {
  const baseSpeed = walkSpeedMap[walkSpeedMode];
  const gameSpeedFactor = 1 + (gameSpeedMultiplier / 100);
  return baseSpeed * gameSpeedFactor;
}

// åˆ†å€è¼”åŠ©å‡½æ•¸
function getStairZone(x, canvasWidth, stairWidth) {
  if (x < canvasWidth * 0.3) return 'left';
  if (x > canvasWidth * 0.7 - stairWidth) return 'right';
  return 'center';
}

function getStairXByZone(zone, canvasWidth, stairWidth) {
  const leftMin = 0, leftMax = canvasWidth * 0.3 - stairWidth;
  const centerMin = canvasWidth * 0.35, centerMax = canvasWidth * 0.65 - stairWidth;
  const rightMin = canvasWidth * 0.7, rightMax = canvasWidth - stairWidth;
  if (zone === 'left') return leftMin + Math.random() * (leftMax - leftMin);
  if (zone === 'center') return centerMin + Math.random() * (centerMax - centerMin);
  if (zone === 'right') return rightMin + Math.random() * (rightMax - rightMin);
  // fallback
  return centerMin + Math.random() * (centerMax - centerMin);
}

function getNextStairZone() {
  // å¦‚æœä»»å‹™æ¸…å–®ç‚ºç©ºä¸”å·²ç”Ÿæˆäº”å€‹éæ°´å¹³ç§»å‹•å¹³å°ï¼Œé‡æ–°ç”Ÿæˆäº”å€‹ä»»å‹™
  if (stairGenTask.length === 0 && stairGenCount >= 5) {
    // ç¢ºä¿åŒ…å«å·¦ã€ä¸­ã€å³å„ä¸€å€‹ï¼Œå¦å¤–å…©å€‹éš¨æ©Ÿ
    stairGenTask = ['left', 'center', 'right', 'random', 'random'];
    // æ‰“äº‚é †åº
    for (let i = stairGenTask.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [stairGenTask[i], stairGenTask[j]] = [stairGenTask[j], stairGenTask[i]];
    }
    stairGenCount = 0; // é‡ç½®è¨ˆæ•¸å™¨
    generatedZones = []; // é‡ç½®å·²ç”Ÿæˆä½ç½®è¨˜éŒ„
  }
  
  // å¦‚æœä»»å‹™æ¸…å–®ç‚ºç©ºä½†é‚„æ²’ç”Ÿæˆäº”å€‹å¹³å°ï¼Œç¹¼çºŒç­‰å¾…
  if (stairGenTask.length === 0) {
    // æ ¹æ“šå·²ç”Ÿæˆçš„ä½ç½®ï¼Œå„ªå…ˆé¸æ“‡ç¼ºå°‘çš„ä½ç½®
    const zones = ['left', 'center', 'right'];
    const missingZones = zones.filter(zone => !generatedZones.includes(zone));
    
    if (missingZones.length > 0) {
      // å„ªå…ˆé¸æ“‡ç¼ºå°‘çš„ä½ç½®
      return missingZones[Math.floor(Math.random() * missingZones.length)];
    } else {
      // å¦‚æœæ‰€æœ‰ä½ç½®éƒ½æœ‰äº†ï¼Œéš¨æ©Ÿé¸æ“‡
      return zones[Math.floor(Math.random() * 3)];
    }
  }
  
  // éš¨æ©Ÿå–ä¸€å€‹ zone
  const idx = Math.floor(Math.random() * stairGenTask.length);
  let zone = stairGenTask[idx];
  stairGenTask.splice(idx, 1);
  
  if (zone === 'random') {
    // åªå…è¨± left/center/right
    const zones = ['left', 'center', 'right'];
    zone = zones[Math.floor(Math.random() * 3)];
  }
  
  return zone;
}

// æ–°å¢ï¼šåªè¨˜éŒ„æœ€è¿‘äº”å€‹éæ°´å¹³ç§»å‹•å¹³å°çš„zone
let lastFiveZones = [];

// æ–°å¢ï¼šæ¨“æ¢¯ç”Ÿæˆåˆ†å¸ƒæ¨¡å¼
const stairZonePattern = ['left', 'random', 'right', 'random'];
let stairZonePatternIdx = 0;
let lastNonHorizontalZone = null;

// æ–°å¢ï¼šæ¨“æ¢¯åŸºæº–åˆ†å¸ƒé»èˆ‡ç´¢å¼•
const stairBasePercents = [0.66, 0.0, 1.0, 0.33];
let stairPatternIdx = 0;
function getPatternStairX(canvasWidth, stairWidth) {
  let basePercent = stairBasePercents[stairPatternIdx];
  let offset = (Math.random() - 0.5) * 0.2 * canvasWidth; // Â±10%ç•«é¢å¯¬åº¦
  let x = basePercent * (canvasWidth - stairWidth) + offset;
  x = Math.max(0, Math.min(canvasWidth - stairWidth, x));
  stairPatternIdx = (stairPatternIdx + 1) % stairBasePercents.length;
  return x;
}

function initGame() {
  var modal = document.getElementById('gameover-modal');
  if (modal) modal.style.display = 'none';
  if (animationFrameId !== null) {
    cancelAnimationFrame(animationFrameId);
    animationFrameId = null;
  }
  // æ–°å¢ï¼šé‡è¨­é¡é ­åç§»
  cameraOffsetY = 0;
  cameraTargetOffsetY = 0;
  resizeCanvas();
  paused = false;
  score = 0;
  direction = Math.random() < 0.5 ? 1 : -1; // 1:å³, -1:å·¦
  jumpPending = false;
  stairWidth = Math.floor(getWidth() * 0.25);
  stairHeight = 12;
  stairGap = stairHeight * 5.5;
  gameSpeed = 1.8;
  platformPassedCount = 0; // å·²ä¸å†ä½¿ç”¨
  lastLandedStair = null; // å·²ä¸å†ä½¿ç”¨
  passedPlatforms = new Set(); // æ–°å¢ï¼šåˆå§‹åŒ–
  allPassedPlatforms = new Set(); // æ–°å¢ï¼šåˆå§‹åŒ–
  shoeBuffActive = false;
  shoeBuffEndTime = 0;
  // æ–°å¢ï¼šåˆå§‹åŒ–æ¨“æ¢¯åˆ†å¸ƒæ§åˆ¶
  recentStairPositions = [];
  // æ–°å¢ï¼šé‡ç½®æ¨“æ¢¯ç”Ÿæˆä»»å‹™
  stairGenTask = [];
  stairGenCount = 0;
  // åˆå§‹åŒ–ç¬¬ä¸€å€‹äº”å€‹ä»»å‹™
  stairGenTask = ['left', 'center', 'right', 'random', 'random'];
  // æ‰“äº‚é †åº
  for (let i = stairGenTask.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [stairGenTask[i], stairGenTask[j]] = [stairGenTask[j], stairGenTask[i]];
  }
  // ä¸»è§’
  player = {
    width: Math.floor(stairWidth * 0.5),
    height: Math.floor(stairWidth * 0.5),
    x: getWidth() / 2 - stairWidth * 0.25,
    y: getHeight() - stairHeight - Math.floor(stairWidth * 0.5),
    vx: getFinalWalkSpeed(),
    vy: 0,
    onStair: true,
    jumping: false,
    jumpPower: -6.5,
    gravity: 0.22,
    dir: direction,
    alive: true,
    power: 0,
    maxPower: 100,
    charging: false,
    chargePending: false, // ç­‰å¾…é›†æ°£çš„ç‹€æ…‹
    powerIncrement: 4,  // æ¯å¹€è“„åŠ›å¢åŠ é‡
    lastJumpTime: null,
    lastLandTime: performance.now() / 1000,
    lastLeaveTime: null,
    landedOn: null, // è¿½è¹¤ç›®å‰ç«™ç«‹çš„å¹³å°
    animationState: {
      bodyBob: 0,
      armSwing: 0,
      legSwing: 0
    }
  };
  // æ¨“æ¢¯é™£åˆ—
  stairs = [];
  // å…ˆåŠ åœ°é¢ï¼ˆæ•´å€‹å¹³é¢ï¼‰
  stairs.push({
    x: 0,
    y: getHeight() - stairHeight,
    width: getWidth(),
    height: stairHeight
  });
  // æ–°å¢ï¼šåˆå§‹åŒ–æ¨“æ¢¯patternç´¢å¼•
  stairPatternIdx = 0;
  // å†åŠ å…¶ä»–æ¨“æ¢¯ï¼ˆæ¯å››å€‹ä¸€çµ„ï¼Œè£œåˆ°å¯è¦‹æ•¸+8ï¼‰
  let y = getHeight() - stairGap - stairHeight;
  const visibleStairCount = Math.ceil(getHeight() / stairGap) + 8;
  while (stairs.length < visibleStairCount) {
    for (let i = 0; i < 4 && stairs.length < visibleStairCount; i++) {
      let basePercent = stairBasePercents[stairPatternIdx];
      // æ±ºå®šå¯ç”¨æ¨“æ¢¯é¡å‹
      let types;
      if (basePercent === 0.0 || basePercent === 1.0) {
        types = ['static', 'spring', 'conveyorL', 'conveyorR', 'vertical', 'upward'];
      } else {
        types = ['static', 'spring', 'conveyorL', 'conveyorR', 'horizontal', 'vertical', 'upward'];
      }
      let type = types[Math.floor(Math.random() * types.length)];
      let vx = 0, vy = 0, rangeX = 0, rangeY = 0, phase = 0;
      if (type === "horizontal") {
        vx = (Math.random() < 0.5 ? -1 : 1) * 0.6;
        rangeX = stairWidth * 1.2;
        phase = Math.random() * Math.PI * 2;
      } else if (type === "vertical") {
        vy = (Math.random() < 0.5 ? -1 : 1) * 0.4;
        rangeY = stairGap * 0.7;
        phase = Math.random() * Math.PI * 2;
      } else if (type === "upward") {
        vy = 0;
        rangeY = stairGap * 0.7;
        phase = Math.random() * Math.PI * 2;
      }
      let x = getPatternStairX(getWidth(), stairWidth);
      const stairIndex = Math.round((getHeight() - stairHeight - y) / stairGap);
      let hasShoe = false, hasPill = false;
      if (stairIndex > 0 && stairIndex % 8 === 0 && Math.random() < 0.3) {
        if (shoeItemEnabled) {
          if (Math.random() < 0.5) {
            hasShoe = true;
          } else {
            hasPill = true;
          }
        }
      }
      stairs.push({x, y, width: stairWidth, height: stairHeight, type, vx, vy, baseX: x, baseY: y, rangeX, rangeY, phase, hasShoe, hasPill
        // æ–°å¢å½ˆç°§å¹³å°å‹•ç•«å±¬æ€§
        , ...(type === 'spring' ? {
          springState: 'normal', // 'normal' | 'compressed' | 'stretching'
          springAnimStart: 0,
          springAnimFrom: stairHeight,
          springAnimTo: stairHeight,
          springCurrentHeight: stairHeight
        } : {})
      });
      y -= stairGap;
    }
  }
  // è¨­å®š lastStair ç‚ºä¸»è§’è…³ä¸‹çš„æ¨“æ¢¯
  lastStair = stairs.find(s =>
    player.x + player.width > s.x &&
    player.x < s.x + s.width &&
    player.y + player.height === s.y
  ) || null;
  player.landedOn = lastStair;
  platformSet = new Set();
  if (lastStair) platformSet.add(lastStair);
  firstPlatformPassed = false;
  drawHUD();
  animationFrameId = requestAnimationFrame(gameLoop);
  sfxJump.muted = sfxMuted;
  sfxDead.muted = sfxMuted;
  sfxLand.muted = sfxMuted;
  sfxSpringJump.muted = sfxMuted;
  sfxCharge.muted = sfxMuted;
  bgm.muted = bgmMuted;
  if (!bgmMuted) tryPlayBgm();
  else bgm.pause();
  // åœ¨initGame()è£¡åˆå§‹åŒ–lastFiveZones
  lastFiveZones = [];
  // åˆå§‹åŒ–æ¨“æ¢¯åˆ†å¸ƒåºåˆ—
  stairZonePatternIdx = 0;
  lastNonHorizontalZone = null;
  // 2. initGame() å…§åˆå§‹åŒ– buff ç‹€æ…‹
  pillBuffActive = false;
  pillBuffEndTime = 0;
  pillScale = 1;
  pillScaleTarget = 1;
  pillScaleAnimStartTime = performance.now();
  // åˆå§‹åŒ–æ¨“æ¢¯é¡å‹æ´—ç‰Œ
  stairTypeShuffle = shuffleArray(['static', 'spring', 'conveyorL', 'conveyorR', 'horizontal', 'vertical', 'upward']);
  stairTypeShuffleIdx = 0;
  stairXPatternIdx = 0; // åˆå§‹åŒ–Xä½ç½®å¾ªç’°
}

function drawPlayer() {
  // å„²å­˜ç•¶å‰ç¹ªåœ–ç‹€æ…‹
  ctx.save();

  // ç©å®¶å°ºå¯¸
  const pW = player.width;
  const pH = player.height;
  
  // å‹•ç•«åƒæ•¸ï¼ˆå—éŠæˆ²é€Ÿåº¦å½±éŸ¿ï¼‰
  const gameSpeedFactor = 1 + (gameSpeedMultiplier / 100);
  const animSpeed = 12 * gameSpeedFactor; // å‹•ç•«é€Ÿåº¦å—éŠæˆ²é€Ÿåº¦å½±éŸ¿
  const animCycle = (performance.now() / 1000) * animSpeed; // å‹•ç•«é€±æœŸ
  
  // èº«é«”ä¸Šä¸‹æ“ºå‹•
  const bodyYOffset = (1 - Math.cos(animCycle * 2)) * (pH * 0.03);

  // === ä¿®æ­£è…³æŒ ===
  // é‹å­é«˜åº¦
  const shoeHeight = pH * 0.08;
  // è† å›Šç¸®æ”¾å‹•ç•«
  // å‹•ç•«æ’å€¼
  let now = performance.now();
  if (pillScale !== pillScaleTarget) {
    let t = Math.min(1, (now - pillScaleAnimStartTime) / PILL_ANIM_DURATION);
    pillScale = pillScale + (pillScaleTarget - pillScale) * t;
    // è‹¥å·²æ¥è¿‘ç›®æ¨™ï¼Œç›´æ¥åˆ°ä½
    if (Math.abs(pillScale - pillScaleTarget) < 0.01) pillScale = pillScaleTarget;
  }
  let scale = pillScale; // ç•¶å‰ç¸®æ”¾æ¯”ä¾‹
  // è¨ˆç®—åŸºç¤Yåº§æ¨™ï¼Œè®“è…³åº•è²¼é½Šå¹³å°
  const baseY = player.y - cameraOffsetY - bodyYOffset - shoeHeight/2;
  const offsetY = (1 - scale) * player.height; // å› ç¸®æ”¾ç”¢ç”Ÿçš„Yä½ç§»
  // ç§»å‹•ä¸¦ç¸®æ”¾ç•«å¸ƒ
  ctx.translate(player.x, baseY + offsetY);
  ctx.scale(scale, scale);

  // å››è‚¢å‹•ç•«é€±æœŸ
  const backArmCycle = animCycle + Math.PI;
  const frontArmCycle = animCycle;
  const backLegCycle = animCycle;
  const frontLegCycle = animCycle + Math.PI;

  // å››è‚¢æ“ºå‹•è§’åº¦
  const armAngle = Math.sin(frontArmCycle) * 1.4;
  const legAngle = Math.sin(backLegCycle) * 1.2; 

  // å…±ç”¨çš„å››è‚¢å±¬æ€§
  const armX = pW / 2; // æ‰‹è‡‚Xä¸­å¿ƒ
  const shoulderY = pH * 0.45; // è‚©è†€Yä½ç½®
  const armWidth = pW * 0.12; // æ‰‹è‡‚å¯¬åº¦
  const armHeight = pH * 0.28; // æ‰‹è‡‚é•·åº¦
  const handRadius = armWidth * 0.5; // æ‰‹åŠå¾‘

  const legWidth = pW * 0.18; // è…¿å¯¬åº¦
  const legHeight = pH * 0.30; // è…¿é•·åº¦
  const legBaseY = pH * 0.75; // è…¿æ ¹éƒ¨Yä½ç½®
  const legBaseX = pW / 2; // è…¿æ ¹éƒ¨Xä¸­å¿ƒ
  const shoeWidth = legWidth * 1.25; // é‹å­å¯¬åº¦

  ctx.save();
  // å¦‚æœç©å®¶å‘å·¦ç§»å‹•ï¼Œç¿»è½‰ç•«å¸ƒ
  if (player.dir === -1) {
    ctx.scale(-1, 1);
    ctx.translate(-pW, 0);
  }

  // èº«é«”å‚¾æ–œ
  const angle = 0.15;
  ctx.translate(pW / 2, pH / 2);
  ctx.rotate(angle);
  ctx.translate(-pW / 2, -pH / 2);

  // --- è“„åŠ›æ•ˆæœ ---
  let chargingFlash = false; // æ˜¯å¦é–ƒçˆ
  if (player.charging || shoeBuffActive) {
    // é–ƒçˆæ•ˆæœï¼šæ¯ 100ms é–ƒçˆä¸€æ¬¡ï¼ˆå—éŠæˆ²é€Ÿåº¦å½±éŸ¿ï¼‰
    chargingFlash = Math.floor(performance.now() / (100 / gameSpeedFactor)) % 2 === 0;
    // é›†æ°£å…‰æšˆï¼ˆå—éŠæˆ²é€Ÿåº¦å½±éŸ¿ï¼‰
    const auraAlpha = 0.25 + 0.25 * Math.sin(performance.now() / (80 / gameSpeedFactor)); // å…‰æšˆé€æ˜åº¦
    const powerRatio = player.power / player.maxPower; // åŠ›é‡æ¯”ä¾‹
    ctx.save();
    ctx.globalAlpha = auraAlpha * (0.3 + 0.7 * powerRatio);
    const auraRadius = pW * (0.6 + 0.7 * powerRatio); // å…‰æšˆåŠå¾‘
    // å»ºç«‹æ”¾å°„ç‹€æ¼¸å±¤
    const grad = ctx.createRadialGradient(pW/2, pH/2, pW*0.15, pW/2, pH/2, auraRadius);
    grad.addColorStop(0, `rgba(255,255,100,0.8)`);
    grad.addColorStop(0.5, `rgba(255,180,0,0.4)`);
    grad.addColorStop(1, `rgba(255,0,0,0)`);
    // ç¹ªè£½å…‰æšˆ
    ctx.beginPath();
    ctx.arc(pW/2, pH/2, auraRadius, 0, Math.PI*2);
    ctx.fillStyle = grad;
    ctx.fill();
    ctx.restore();
  } else if (player.chargePending && player.alive) {
    // ç­‰å¾…é›†æ°£çš„è¦–è¦ºæç¤ºï¼šæŸ”å’Œçš„ç™½è‰²è„ˆå‹•å…‰æšˆï¼ˆå—éŠæˆ²é€Ÿåº¦å½±éŸ¿ï¼‰
    ctx.save();
    ctx.globalAlpha = 0.2 + 0.2 * Math.sin(performance.now() / (120 / gameSpeedFactor));
    const grad = ctx.createRadialGradient(pW/2, pH/2, pW*0.2, pW/2, pH/2, pW*0.7);
    grad.addColorStop(0, `rgba(230, 230, 255, 0.8)`);
    grad.addColorStop(1, `rgba(200, 200, 255, 0)`);
    ctx.beginPath();
    ctx.arc(pW/2, pH/2, pW * 0.7, 0, Math.PI*2);
    ctx.fillStyle = grad;
    ctx.fill();
    ctx.restore();
  }

  // --- ç¹ªè£½é †åº: å¾å¾Œåˆ°å‰ ---

  // å¾Œè…¿
  ctx.save();
  ctx.translate(legBaseX, legBaseY);
  ctx.rotate(legAngle);
  ctx.fillStyle = chargingFlash ? '#FF2222' : '#0000B2'; // è…¿é¡è‰²ï¼Œé–ƒçˆæ™‚ç‚ºç´…è‰²
  ctx.fillRect(-legWidth / 2, 0, legWidth, legHeight);
  ctx.fillStyle = chargingFlash ? '#FF8888' : '#6B3503'; // é‹å­é¡è‰²
  ctx.fillRect(-shoeWidth / 2, legHeight - shoeHeight / 2, shoeWidth, shoeHeight);
  ctx.restore();

  // å¾Œè‡‚
  ctx.save();
  ctx.translate(armX, shoulderY);
  ctx.rotate(armAngle);
  ctx.fillStyle = chargingFlash ? '#FF6666' : '#00A090'; // æ‰‹è‡‚é¡è‰²
  ctx.fillRect(-armWidth / 2, 0, armWidth, armHeight);
  ctx.fillStyle = chargingFlash ? '#FFD1D1' : '#D1B497'; // æ‰‹é¡è‰²
  ctx.beginPath();
  ctx.arc(0, armHeight + handRadius * 0.5, handRadius, 0, Math.PI * 2);
  ctx.fill();
  ctx.restore();

  // èº«é«”/è¡£æœ
  ctx.fillStyle = chargingFlash ? '#FF4444' : '#00D0B0';
  ctx.fillRect(pW * 0.35, pH * 0.45, pW * 0.3, pH * 0.30);

  // å‰è…¿
  ctx.save();
  ctx.translate(legBaseX, legBaseY);
  ctx.rotate(-legAngle);
  ctx.fillStyle = chargingFlash ? '#FF3333' : '#0000FF'; // è…¿é¡è‰²
  ctx.fillRect(-legWidth / 2, 0, legWidth, legHeight);
  ctx.fillStyle = chargingFlash ? '#FFAAAA' : '#8B4513'; // é‹å­é¡è‰²
  ctx.fillRect(-shoeWidth / 2, legHeight - shoeHeight/2, shoeWidth, shoeHeight);
  ctx.restore();

  // å‰è‡‚
  ctx.save();
  ctx.translate(armX, shoulderY);
  ctx.rotate(-armAngle);
  ctx.fillStyle = chargingFlash ? '#FF8888' : '#00D0B0'; // æ‰‹è‡‚é¡è‰²
  ctx.fillRect(-armWidth / 2, 0, armWidth, armHeight);
  ctx.fillStyle = chargingFlash ? '#FFD1D1' : '#F2D1B3'; // æ‰‹é¡è‰²
  ctx.beginPath();
  ctx.arc(0, armHeight + handRadius * 0.5, handRadius, 0, Math.PI * 2);
  ctx.fill();
  ctx.restore();

  // é ­éƒ¨å’Œè‡‰éƒ¨ç´°ç¯€
  ctx.fillStyle = chargingFlash ? '#FFD1D1' : '#F2D1B3'; // é ­éƒ¨é¡è‰²
  ctx.beginPath();
  ctx.arc(pW / 2, pH * 0.25, pW * 0.23, 0, Math.PI * 2);
  ctx.fill();

  // é ­é«®
  ctx.save();
  ctx.fillStyle = chargingFlash ? '#FF8888' : '#000'; // é ­é«®é¡è‰²
  ctx.beginPath();
  // åŠåœ“å½¢é ­é«®ï¼Œç•«åœ¨é ­çš„å·¦å¾Œæ–¹
  ctx.arc(pW * 0.36, pH * 0.25, pW * 0.11, Math.PI * 0.5, Math.PI * 1.5, false);
  ctx.closePath();
  ctx.fill();
  ctx.restore();

  // å¸½å­ä¸»é«” (åŠåœ“å½¢ï¼Œé¡è‰²èˆ‡è¡£æœç›¸åŒ)
  ctx.fillStyle = chargingFlash ? '#FF4444' : '#00D0B0';
  ctx.beginPath();
  ctx.arc(pW / 2, pH * 0.25, pW * 0.24, Math.PI, Math.PI * 2);
  ctx.fill();
  // å¸½æ²¿
  ctx.fillStyle = chargingFlash ? '#FFCCCC' : '#50C8FF'; // å¸½æ²¿é¡è‰²
  ctx.fillRect(pW / 2, pH * 0.20, pW * 0.32, pH * 0.06);

  // çœ¼ç›å’Œè‡‰é ° (æœ€ä¸Šå±¤)
  ctx.fillStyle = '#000'; // çœ¼ç›é¡è‰²
  const eyeY = pH * 0.3;
  const eyeHeight = pH * 0.035;
  ctx.fillRect(pW * 0.60, eyeY, pW * 0.1, eyeHeight);
  ctx.fillStyle = chargingFlash ? '#FFAAAA' : '#FFB6C1'; // è‡‰é °é¡è‰²
  ctx.beginPath();
  ctx.arc(pW * 0.55, pH * 0.38, pW * 0.06, 0, Math.PI * 2);
  ctx.fill();

  // æ¢å¾©ç¿»è½‰å‰çš„ç‹€æ…‹
  ctx.restore(); 
  
  // ç©å®¶é ­ä¸Šçš„åŠ›é‡æ¢
  if (player.charging) {
    const barWidth = player.width * 0.8;
    const barHeight = 5;
    const barX = (player.width - barWidth) / 2; // ç›¸å°æ–¼ç©å®¶Xç½®ä¸­
    const barY = -barHeight - 5; // åœ¨é ­é ‚ä¸Šæ–¹5px

    // åŠ›é‡æ¢èƒŒæ™¯
    ctx.fillStyle = '#333';
    ctx.fillRect(barX, barY, barWidth, barHeight);
    
    // åŠ›é‡æ¢å¡«å……
    const powerRatio = player.power / player.maxPower;
    const powerWidth = powerRatio * barWidth;

    // é¡è‰²å¹³æ»‘éæ¸¡ï¼šç´…â†’é»ƒâ†’ç¶ 
    let color;
    if (powerRatio <= 1/3) {
      color = '#ff3333'; // ç´…è‰²
    } else if (powerRatio < 1) {
      // å¾ç´…åˆ°é»ƒåˆ°ç¶ ï¼Œä½¿ç”¨HSLè‰²ç›¸0~120
      let t = (powerRatio - 1/3) / (2/3); // å°‡ 1/3~1 çš„ç¯„åœæ­£è¦åŒ–åˆ° 0~1
      // 0~0.5: ç´…åˆ°é»ƒ (è‰²ç›¸ 0~60), 0.5~1: é»ƒåˆ°ç¶  (è‰²ç›¸ 60~120)
      let hue;
      if (t < 0.5) {
        hue = 0 + t * 2 * 60; // 0~60
      } else {
        hue = 60 + (t - 0.5) * 2 * 60; // 60~120
      }
      color = `hsl(${hue}, 100%, 50%)`;
    } else {
      color = '#00e000'; // ç¶ è‰² (æ»¿æ°£)
    }
    ctx.fillStyle = color;
    ctx.fillRect(barX, barY, powerWidth, barHeight);

    // åŠ›é‡æ¢é‚Šæ¡†
    ctx.strokeStyle = '#fff';
    ctx.lineWidth = 1;
    ctx.strokeRect(barX, barY, barWidth, barHeight);
  }

  // Buff å€’æ•¸è¨ˆæ™‚é¡¯ç¤º (é‹å­æˆ–è† å›Šï¼Œäº’æ–¥)
  let buffRemain = null, buffType = null;
  if (shoeBuffActive && (!pillBuffActive || shoeBuffEndTime > pillBuffEndTime)) {
    buffRemain = Math.ceil((shoeBuffEndTime - performance.now()) / 1000);
    buffType = 'shoe';
  } else if (pillBuffActive) {
    buffRemain = Math.ceil((pillBuffEndTime - performance.now()) / 1000);
    buffType = 'pill';
  }
  if (buffRemain && buffRemain > 0) {
    ctx.save();
    ctx.font = `${Math.round(player.height * 0.45)}px Arial Black, Arial, sans-serif`;
    ctx.textAlign = 'center';
    ctx.textBaseline = 'bottom';
    ctx.fillStyle = buffType === 'pill' ? '#2196f3' : '#ffe600'; // è† å›Šè—è‰²ï¼Œé‹å­é»ƒè‰²
    ctx.strokeStyle = '#222';
    ctx.lineWidth = 4;
    ctx.strokeText(buffRemain, player.width / 2, -player.height * 0.18);
    ctx.fillText(buffRemain, player.width / 2, -player.height * 0.18);
    ctx.restore();
  }

  // æœ€çµ‚æ¢å¾©ç¹ªåœ–ç‹€æ…‹
  ctx.restore();
}

function drawStairs() {
  ctx.save();
  
  // è¨ˆç®—éŠæˆ²é€Ÿåº¦å€æ•¸ï¼ˆç”¨æ–¼å‹•ç•«æ•ˆæœï¼‰
  const gameSpeedFactor = 1 + (gameSpeedMultiplier / 100);
  
  for (let s of stairs) {
    let drawY = s.y - cameraOffsetY;
    if (s.type === 'spring') {
      // ä»¥ springCurrentHeight ç•«ï¼Œåº•éƒ¨å›ºå®š
      const springH = s.springCurrentHeight || s.height;
      const drawY = s.y - cameraOffsetY + (s.height - springH);
      // é»‘è‰²ä¸»é«”
      ctx.fillStyle = '#000';
      ctx.fillRect(s.x, drawY, s.width, springH);
      // ä¸Šä¸‹äº®ç¶ è‰²é‚Š
      const borderWidth = Math.max(3, springH * 0.18);
      ctx.fillStyle = '#39FF14';
      ctx.fillRect(s.x, drawY, s.width, borderWidth); // ä¸Š
      ctx.fillRect(s.x, drawY + springH - borderWidth, s.width, borderWidth); // ä¸‹
      // å››æ ¹å½ˆç°§
      ctx.save();
      ctx.beginPath();
      ctx.rect(s.x, drawY, s.width, springH);
      ctx.clip();
      ctx.strokeStyle = '#fff';
      ctx.lineWidth = Math.max(2, springH * 0.13);
      const springCount = 4;
      const springSpacing = s.width / 5;
      // springH å–ä»£ s.height
      const springWaveH = springH - borderWidth * 2;
      const springW = springSpacing * 0.8;
      const springY = drawY + borderWidth;
      const springPositions = [
        s.x + springSpacing * 1.0,
        s.x + springSpacing * 2.0,
        s.x + springSpacing * 3.0,
        s.x + springSpacing * 4.0
      ];
      for (let sp = 0; sp < springCount; sp++) {
        const centerX = springPositions[sp];
        ctx.beginPath();
        for (let t = 0; t <= 1; t += 0.05) {
          const wave = Math.sin(t * Math.PI * 4) * (springW / 2.5);
          const x = centerX + wave;
          const y = springY + t * springWaveH;
          if (t === 0) ctx.moveTo(x, y);
          else ctx.lineTo(x, y);
        }
        ctx.stroke();
      }
      ctx.restore();
      ctx.lineWidth = 1;
    } else if (s.type === 'conveyorL' || s.type === 'conveyorR') {
      // ç°è‰²åº•
      ctx.fillStyle = '#bbb';
      ctx.fillRect(s.x, drawY, s.width, s.height);
      ctx.strokeStyle = '#888';
      ctx.lineWidth = 2;
      ctx.strokeRect(s.x, drawY, s.width, s.height);
      // ç•«å·¦å³åŠåœ“
      ctx.save();
      ctx.fillStyle = '#bbb';
      // å·¦åŠåœ“
      ctx.beginPath();
      ctx.arc(s.x, drawY + s.height / 2, s.height / 2, Math.PI / 2, Math.PI * 3 / 2, false);
      ctx.fill();
      // å³åŠåœ“
      ctx.beginPath();
      ctx.arc(s.x + s.width, drawY + s.height / 2, s.height / 2, Math.PI * 3 / 2, Math.PI / 2, false);
      ctx.fill();
      ctx.restore();
      // ç•«ç§»å‹•çš„æ©«ç·šï¼ˆå—éŠæˆ²é€Ÿåº¦å½±éŸ¿ï¼‰
      ctx.strokeStyle = '#666';
      ctx.lineWidth = 1;
      let anim = (performance.now() / (30 / gameSpeedFactor)) % 12;
      let lineOffset = (s.type === 'conveyorL' ? -anim : anim);
      for (let i = 0; i < s.width; i += 12) {
        let xPos = s.x + i + lineOffset;
        if (xPos >= s.x && xPos <= s.x + s.width) {
          ctx.beginPath();
          ctx.moveTo(xPos, drawY);
          ctx.lineTo(xPos, drawY + s.height);
          ctx.stroke();
        }
      }
      // ç•«ç®­é ­
      ctx.strokeStyle = '#fff';
      ctx.lineWidth = 2;
      let arrowY = drawY + s.height / 2;
      let arrowSpacing = s.width / 4;
      for (let i = 1; i <= 3; i++) {
        let arrowX = s.x + (i * arrowSpacing);
        ctx.beginPath();
        if (s.type === 'conveyorL') {
          ctx.moveTo(arrowX + 4, arrowY - 4);
          ctx.lineTo(arrowX - 4, arrowY);
          ctx.lineTo(arrowX + 4, arrowY + 4);
        } else {
          ctx.moveTo(arrowX - 4, arrowY - 4);
          ctx.lineTo(arrowX + 4, arrowY);
          ctx.lineTo(arrowX - 4, arrowY + 4);
        }
        ctx.stroke();
      }
    } else {
      ctx.fillStyle = '#c97a3a'; // æ©˜æ£•è‰²
      ctx.fillRect(s.x, drawY, s.width, s.height);
      ctx.strokeStyle = '#a05a1a'; // æ·±æ£•è‰²é‚Šæ¡†
      ctx.lineWidth = 3;
      ctx.strokeRect(s.x, drawY, s.width, s.height);
      ctx.lineWidth = 1;
    }
    // ç•«é›è…¿é“å…·
    if (s.hasShoe) {
      ctx.save();
      ctx.translate(s.x + s.width/2, drawY - s.height - 8); // æŠ¬é«˜åˆ°å¹³å°ä¸Šæ–¹
      ctx.rotate(Math.PI / 16); // è‚‰çš„ä¸»é«”å¾®å¾®å‚¾æ–œ
      ctx.scale(1.2, 1.2);

      // å…ˆç•«éª¨é ­ï¼ˆåŠ å¤§å°ºå¯¸ï¼Œéª¨é ­å†é †æ™‚é‡æ—‹è½‰30åº¦ï¼‰
      ctx.save();
      ctx.translate(7, 7); // ä»¥éª¨é ­ä¸­å¿ƒç‚ºåŸé»æ—‹è½‰
      ctx.rotate(Math.PI/6); // 30åº¦
      ctx.translate(-7, -7);
      // éª¨å¹¹
      ctx.beginPath();
      ctx.moveTo(6, 5.5);
      ctx.lineTo(15, 5.5);
      ctx.lineTo(15, 8.5);
      ctx.lineTo(6, 8.5);
      ctx.closePath();
      ctx.fillStyle = '#f9f6f2';
      ctx.fill();
      // éª¨é ­åœ“é ­ï¼ˆå·¦ç«¯ï¼‰
      ctx.beginPath();
      ctx.arc(6, 7, 3, 0, Math.PI*2);
      ctx.fillStyle = '#f9f6f2';
      ctx.fill();
      // éª¨é ­åœ“é ­ï¼ˆå³ç«¯ï¼‰
      ctx.beginPath();
      ctx.arc(15, 7, 3.5, 0, Math.PI*2);
      ctx.fillStyle = '#f9f6f2';
      ctx.fill();
      // éª¨é ­é™°å½±
      ctx.beginPath();
      ctx.arc(15, 7, 2.7, Math.PI*0.2, Math.PI*1.2);
      ctx.fillStyle = 'rgba(180,180,180,0.18)';
      ctx.fill();
      ctx.restore();

      // å†ç•«é›è…¿è‚‰ï¼ˆä¸»é«”ï¼‰
      ctx.beginPath();
      ctx.ellipse(-2, 4, 10, 7, 0, 0, Math.PI*2);
      ctx.fillStyle = '#e8a14a';
      ctx.shadowColor = '#b86b1b';
      ctx.shadowBlur = 4;
      ctx.fill();
      ctx.shadowBlur = 0;
      // é›è…¿è‚‰é«˜å…‰
      ctx.beginPath();
      ctx.ellipse(-7, 1, 3, 1.2, -Math.PI/12, 0, Math.PI*2);
      ctx.fillStyle = 'rgba(255,255,255,0.18)';
      ctx.fill();

      ctx.restore();
    }
    // ç¹ªè£½è—¥ä¸¸
    if (s.hasPill) {
      ctx.save();
      ctx.translate(s.x + s.width/2, drawY - s.height - 8); // å¹³å°ä¸Šæ–¹
      ctx.rotate(Math.PI / 12); // å¾®å‚¾æ–œ
      ctx.scale(1.3, 1.3);
      // è—ç™½è† å›Š
      ctx.beginPath();
      ctx.ellipse(0, 0, 10, 5, 0, 0, Math.PI*2);
      ctx.fillStyle = '#fff';
      ctx.fill();
      ctx.beginPath();
      ctx.ellipse(-3, 0, 7, 5, 0, Math.PI*0.5, Math.PI*1.5);
      ctx.fillStyle = '#2196f3';
      ctx.fill();
      ctx.beginPath();
      ctx.ellipse(0, 0, 10, 5, 0, 0, Math.PI*2);
      ctx.strokeStyle = '#2196f3';
      ctx.lineWidth = 2;
      ctx.stroke();
      ctx.restore();
    }
  }
  ctx.restore();
}

function drawHUD() {
  const hudPower = document.querySelector('#hud .hud-power');
  if (hudPower && player) {
    let html = '';
    let percent = player.power / player.maxPower;
    let barCount = 12;
    for (let i = 0; i < barCount; i++) {
      if (i < Math.round(percent * barCount)) {
        html += `<span style=\"display:inline-block;width:6px;height:12px;background:#ffe600;border:1px solid #fff;margin-right:1px;box-shadow:0 0 2px #fff;\"></span>`;
      } else {
        html += `<span style=\"display:inline-block;width:6px;height:12px;background:#111;border:1px solid #444;margin-right:1px;\"></span>`;
      }
    }
    hudPower.innerHTML = html;
  }
  const hudScore = document.getElementById('hud-score');
  if (hudScore) {
    hudScore.innerHTML = `<span class='score-num'>${String(score).padStart(4, "0")}</span><span class='score-unit'>éš</span>`;
  }
  const hudHighscore = document.getElementById('hud-highscore');
  if (hudHighscore) {
    hudHighscore.textContent = `æœ€é«˜ ${String(highScore).padStart(4, "0")}`;
  }
  const sfxToggle = document.getElementById('sfx-toggle');
  const bgmToggle = document.getElementById('bgm-toggle');
  const pauseToggle = document.getElementById('pause-toggle');
  const settingsToggle = document.getElementById('settings-toggle');
  const helpToggle = document.getElementById('help-toggle');
  const aboutToggle = document.getElementById('about-toggle');
  if (sfxToggle) sfxToggle.textContent = (sfxMuted ? 'ğŸ”‡' : 'ğŸ”Š') + ' éŸ³æ•ˆ';
  if (bgmToggle) bgmToggle.textContent = (bgmMuted ? 'ğŸ”‡' : 'ğŸµ') + ' éŸ³æ¨‚';
  if (pauseToggle) pauseToggle.textContent = paused ? 'â–¶ï¸ ç¹¼çºŒ' : 'â¸ï¸ æš«åœ';
  if (settingsToggle) settingsToggle.textContent = 'âš™ï¸ è¨­å®š';
  if (helpToggle) helpToggle.textContent = 'â“ èªªæ˜';
  if (aboutToggle) aboutToggle.textContent = 'â„¹ï¸ é—œæ–¼';
}

function updatePlayer() {
  if (!player.alive) return false;
  
  // è¨ˆç®—éŠæˆ²é€Ÿåº¦å€æ•¸ï¼ˆç”¨æ–¼æ‰€æœ‰ç‰©ç†å’Œç§»å‹•æ•ˆæœï¼‰
  const gameSpeedFactor = 1 + (gameSpeedMultiplier / 100);
  
  // è‡ªå‹•å·¦å³ç§»å‹•ï¼ˆå—éŠæˆ²é€Ÿåº¦å½±éŸ¿ï¼‰
  player.x += player.vx * player.dir * gameSpeedFactor;
  // ç¢°ç‰†è‡ªå‹•åå‘
  if (player.x < 0) {
    player.x = 0;
    player.dir = 1;
  } else if (player.x + player.width > getWidth()) {
    player.x = getWidth() - player.width;
    player.dir = -1;
  }

  // --- é‡æ§‹å‚ç›´ç§»å‹•èˆ‡å¹³å°äº’å‹•é‚è¼¯ ---
  let justLanded = false;

  // 1. å¦‚æœç©å®¶åœ¨å¹³å°ä¸Šï¼Œè®“ä»–"é»ä½"ä¸¦æª¢æŸ¥æ˜¯å¦èµ°ä¸‹å¹³å°
  if (player.onStair && player.landedOn) {
    const platform = player.landedOn;
    // æª¢æŸ¥Xè»¸æ˜¯å¦é‚„åœ¨å¹³å°ç¯„åœå…§ï¼ˆå¢åŠ å®¹è¨±ç¯„åœï¼‰
    const tolerance = pillBuffActive ? player.width * 0.3 : player.width * 0.1; // å·¨å¤§åŒ– buff æ™‚å®¹è¨±åº¦æ›´å¤§
    if (player.x + player.width > platform.x - tolerance && player.x < platform.x + platform.width + tolerance) {
        player.y = platform.y - player.height; // é–å®šYåº§æ¨™
        player.vy = 0; // ç«™åœ¨å¹³å°ä¸Šæ™‚æ²’æœ‰å‚ç›´é€Ÿåº¦
        // å½ˆç°§å¹³å°å£“ç¸®
        if (platform.type === 'spring' && platform.springState !== 'compressed') {
          platform.springState = 'compressed';
        }
    } else {
        // ç©å®¶èµ°å‡ºäº†å¹³å°Xè»¸ç¯„åœ
        // å½ˆç°§å¹³å°æ‹‰ä¼¸å‹•ç•«
        if (platform.type === 'spring' && platform.springState === 'compressed') {
          platform.springState = 'stretching';
          platform.springAnimStart = performance.now();
          platform.springAnimFrom = platform.height / 2;
          platform.springAnimTo = platform.height * 2;
        }
        player.onStair = false;
        player.landedOn = null;
        player.lastLeaveTime = performance.now() / 1000;
    }
  }

  // 2. å¦‚æœç©å®¶åœ¨ç©ºä¸­ï¼Œæ–½åŠ é‡åŠ›ä¸¦æª¢æŸ¥æ˜¯å¦è½åœ°
  if (!player.onStair) {
    // é‡åŠ›ï¼ˆå—éŠæˆ²é€Ÿåº¦å½±éŸ¿ï¼‰
    player.vy += player.gravity * gameSpeedFactor;
    // é™åˆ¶æœ€å¤§ä¸‹å¢œé€Ÿåº¦
    player.vy = Math.min(player.vy, 12);
    
    // è¨˜éŒ„å‰ä¸€å¹€åº•éƒ¨
    let prevBottom = player.y + player.height;
    player.y += player.vy;
    let currBottom = player.y + player.height;

    // ç©¿è¶Šå¹³å°è¨ˆåˆ†é‚è¼¯
    if (currBottom < prevBottom) { // åªåœ¨ä¸Šå‡æ™‚æª¢æŸ¥
      for (let s of stairs) {
        if (s.y === getHeight() - stairHeight) continue; // è·³éåœ°é¢
        if (
          prevBottom > s.y && currBottom <= s.y &&
          !allPassedPlatforms.has(s.y)
        ) {
          passedPlatforms.add(s.y);
          allPassedPlatforms.add(s.y);
        }
      }
      if (passedPlatforms.size >= 5) {
        score++;
        passedPlatforms.clear();
      }
    }

    // æª¢æŸ¥æ˜¯å¦è½åœ¨æ–°æ¨“æ¢¯ä¸Š
    if (player.vy >= 0) { // åªåœ¨ä¸‹å¢œæ™‚æª¢æŸ¥
        for (let s of stairs) {
            // å¢åŠ å®¹è¨±ç¯„åœï¼Œè®“ç²¾éˆå¯ä»¥ç¨å¾®è¶…å‡ºå¹³å°é‚Šç•Œ
            const tolerance = pillBuffActive ? player.width * 0.3 : player.width * 0.1; // å·¨å¤§åŒ– buff æ™‚å®¹è¨±åº¦æ›´å¤§
            if (player.x + player.width > s.x - tolerance &&
                player.x < s.x + s.width + tolerance &&
                prevBottom <= s.y &&
                currBottom >= s.y) {
              // å½ˆç°§å¹³å°å£“ç¸®
              if (s.type === 'spring' && s.springState !== 'compressed') {
                s.springState = 'compressed';
              }
              player.y = s.y - player.height;
              player.vy = 0;
              player.onStair = true;
              player.landedOn = s;
              justLanded = true;
              player.lastLandTime = performance.now() / 1000;

              // å¦‚æœåœ¨ç©ºä¸­æ™‚å·²æŒ‰ä¸‹(pending)ï¼Œå‰‡è½åœ°ç¬é–“ç«‹å³é–‹å§‹é›†æ°£
              if (player.chargePending) {
                  startCharge();
                  player.chargePending = false; // æ¸…é™¤ç­‰å¾…ç‹€æ…‹
              }

              // Jump buffer: å¦‚æœæœ‰ç·©è¡ï¼Œè½åœ°ç¬é–“è‡ªå‹•è·³
              if (jumpBufferTimer > 0) {
                  jumpBufferTimer = 0;
                  // è‹¥æ²’é›†æ°£ï¼Œçµ¦æœ€å°åŠ›é‡
                  if (!player.charging) {
                      player.power = 1;
                      player.charging = true;
                  }
                  releaseJump();
              }

              // è™•ç†å‰›è½åœ°æ™‚çš„å¹³å°æ•ˆæœï¼ˆå—éŠæˆ²é€Ÿåº¦å½±éŸ¿ï¼‰
              if (s.type === 'conveyorL') {
                  player.x -= 0.6 * gameSpeedFactor;
              } else if (s.type === 'conveyorR') {
                  player.x += 0.6 * gameSpeedFactor;
              }
              if (player.jumping) {
                  player.jumping = false;
                  if (s.y !== getHeight() - stairHeight && lastLandedStairY !== s.y && (player.y + player.height - cameraOffsetY) < getHeight() * 0.5) {
                      needScrollToStair = true;
                      lastLandedStairY = s.y;
                  }
              }
              // æª¢æŸ¥æ˜¯å¦åƒåˆ°é‹å‹•é‹
              if (s.hasShoe) {
                s.hasShoe = false;
                // äº’æ–¥ï¼šåƒåˆ°é›è…¿æ™‚å–æ¶ˆè† å›Šbuffï¼Œä¸¦è§¸ç™¼ç¸®å°å‹•ç•«
                if (pillBuffActive || pillScale > 1) {
                  pillScaleTarget = 1;
                  pillScaleAnimStartTime = performance.now();
                }
                pillBuffActive = false;
                shoeBuffActive = true;
                shoeBuffEndTime = performance.now() + 10000;
              }
              break; // æ‰¾åˆ°å¹³å°å°±åœæ­¢æª¢æŸ¥
          }
      }
    }
  } else {
    // å¦‚æœç©å®¶åœ¨å¹³å°ä¸Šï¼ŒæŒçºŒè™•ç†å¹³å°æ•ˆæœï¼ˆå—éŠæˆ²é€Ÿåº¦å½±éŸ¿ï¼‰
    const s = player.landedOn;
    if (s && s.type === 'conveyorL') {
        player.x -= 0.5 * gameSpeedFactor;
    } else if (s && s.type === 'conveyorR') {
        player.x += 0.5 * gameSpeedFactor;
    }
  }

  // æ’­æ”¾è½åœ°éŸ³æ•ˆ
  if (justLanded) {
    playSfx(sfxLand);
  }

  // æ‰å‡ºç•«é¢
  if (player.y + player.height - cameraOffsetY > getHeight()) {
    player.alive = false;
    setTimeout(() => {
      playSfx(sfxDead);
      if (score > highScore) {
        highScore = score;
        localStorage.setItem('ns_tower_highscore', highScore);
      }
      showGameOverModal(score, score >= highScore);
    }, 100);
    return false;
  }
  // è·³èµ·ä¾†æ™‚è‡ªå‹•è·Ÿéš¨ï¼šç²¾éˆé‚„æ²’è½åœ°ä¸”é«˜åº¦é”åˆ°ç•«é¢90%æ™‚
  if (
    player.alive &&
    !player.onStair &&
    (player.y + player.height - cameraOffsetY) < getHeight() * 0.1
  ) {
    needScrollToStair = true;
  }
  // buffçµæŸè‡ªå‹•æ¢å¾©
  if (shoeBuffActive && performance.now() > shoeBuffEndTime) {
    shoeBuffActive = false;
    // è‹¥é‹å­buffçµæŸä¸”è† å›Šæ²’åœ¨ä½œç”¨ï¼Œç¸®å›å»
    if (!pillBuffActive) {
      pillScaleTarget = 1;
      pillScaleAnimStartTime = performance.now();
    }
  }
  if (pillBuffActive && performance.now() > pillBuffEndTime) {
    pillBuffActive = false;
    pillScaleTarget = 1;
    pillScaleAnimStartTime = performance.now();
  }

  // æª¢æŸ¥æ˜¯å¦åƒåˆ°é›è…¿ï¼ˆä¸åªè½åœ°æ™‚ï¼Œå¾ä¸‹å¾€ä¸Šç©¿éä¹Ÿç®—ï¼‰
  for (let s of stairs) {
    if (s.hasShoe) {
      // é›è…¿çš„ä¸­å¿ƒä½ç½®
      const drumstickX = s.x + s.width/2;
      const drumstickY = s.y - s.height - 8 + 4; // +4ç‚ºé›è…¿æ©¢åœ“ä¸­å¿ƒ
      // é›è…¿å¤–æ¥çŸ©å½¢
      const drumW = 20, drumH = 16; // æ©¢åœ“å¤§è‡´å¯¬é«˜
      const drumRect = {
        left: drumstickX - drumW/2,
        right: drumstickX + drumW/2,
        top: drumstickY - drumH/2,
        bottom: drumstickY + drumH/2
      };
      // ä¸»è§’çŸ©å½¢
      const px = player.x, py = player.y, pw = player.width, ph = player.height;
      const playerRect = {
        left: px,
        right: px + pw,
        top: py,
        bottom: py + ph
      };
      // åˆ¤æ–·æœ‰ç„¡é‡ç–Š
      if (
        playerRect.left < drumRect.right &&
        playerRect.right > drumRect.left &&
        playerRect.top < drumRect.bottom &&
        playerRect.bottom > drumRect.top
      ) {
        s.hasShoe = false;
        // äº’æ–¥ï¼šåƒåˆ°é›è…¿æ™‚å–æ¶ˆè† å›Šbuffï¼Œä¸¦è§¸ç™¼ç¸®å°å‹•ç•«
        if (pillBuffActive || pillScale > 1) {
          pillScaleTarget = 1;
          pillScaleAnimStartTime = performance.now();
        }
        pillBuffActive = false;
        shoeBuffActive = true;
        shoeBuffEndTime = performance.now() + 10000;
      }
    }
  }

  // æª¢æŸ¥æ˜¯å¦åƒåˆ°è—¥ä¸¸
  for (let s of stairs) {
    if (s.hasPill) {
      // è—¥ä¸¸ä¸­å¿ƒ
      const pillX = s.x + s.width/2;
      const pillY = s.y - s.height - 8;
      const pillW = 20, pillH = 10;
      const pillRect = {
        left: pillX - pillW/2,
        right: pillX + pillW/2,
        top: pillY - pillH/2,
        bottom: pillY + pillH/2
      };
      // ä¸»è§’çŸ©å½¢
      const px = player.x, py = player.y, pw = player.width, ph = player.height;
      const playerRect = {
        left: px,
        right: px + pw,
        top: py,
        bottom: py + ph
      };
      if (
        playerRect.left < pillRect.right &&
        playerRect.right > pillRect.left &&
        playerRect.top < pillRect.bottom &&
        playerRect.bottom > pillRect.top
      ) {
        s.hasPill = false;
        // äº’æ–¥ï¼šåƒåˆ°è† å›Šæ™‚å–æ¶ˆé›è…¿buffï¼Œä¸¦è§¸ç™¼æ”¾å¤§å‹•ç•«
        if (!pillBuffActive || pillScale < 2) {
          pillScaleTarget = 2;
          pillScaleAnimStartTime = performance.now();
        }
        shoeBuffActive = false;
        shoeBuffEndTime = 0;
        pillBuffActive = true;
        pillBuffEndTime = performance.now() + 10000;
      }
    }
  }
  // buffçµæŸè‡ªå‹•æ¢å¾©
  if (shoeBuffActive && performance.now() > shoeBuffEndTime) {
    shoeBuffActive = false;
    // è‹¥é‹å­buffçµæŸä¸”è† å›Šæ²’åœ¨ä½œç”¨ï¼Œç¸®å›å»
    if (!pillBuffActive) {
      pillScaleTarget = 1;
      pillScaleAnimStartTime = performance.now();
    }
  }
  if (pillBuffActive && performance.now() > pillBuffEndTime) {
    pillBuffActive = false;
    pillScaleTarget = 1;
    pillScaleAnimStartTime = performance.now();
  }

  return true;
}

function updateStairs() {
  // ç§»é™¤è¶…å‡ºé¡é ­ä¸‹æ–¹çš„æ¨“æ¢¯èˆ‡åœ°é¢ï¼ˆåªä¿ç•™å¯è¦‹+ä¸€çµ„ï¼‰
  stairs = stairs.filter(s => s.y - cameraOffsetY < getHeight() + stairGap * 4);
  stairWidth = Math.floor(getWidth() * 0.25);
  const visibleStairCount = Math.ceil(getHeight() / stairGap) + 8;
  while (stairs.length < visibleStairCount) {
    let lastY = stairs.length > 0 ? stairs[stairs.length - 1].y : getHeight();
    for (let i = 0; i < 4 && stairs.length < visibleStairCount; i++) {
      let newY = lastY - stairGap;
      let basePercent = stairBasePercents[stairPatternIdx];
      // æ±ºå®šå¯ç”¨æ¨“æ¢¯é¡å‹
      let types;
      if (basePercent === 0.0 || basePercent === 1.0) {
        types = ['static', 'spring', 'conveyorL', 'conveyorR', 'vertical', 'upward'];
      } else {
        types = ['static', 'spring', 'conveyorL', 'conveyorR', 'horizontal', 'vertical', 'upward'];
      }
      let type = types[Math.floor(Math.random() * types.length)];
      let vx = 0, vy = 0, rangeX = 0, rangeY = 0, phase = 0;
      if (type === "horizontal") {
        vx = (Math.random() < 0.5 ? -1 : 1) * 0.6;
        rangeX = stairWidth * 1.2;
        phase = Math.random() * Math.PI * 2;
      } else if (type === "vertical") {
        vy = (Math.random() < 0.5 ? -1 : 1) * 0.4;
        rangeY = stairGap * 0.7;
        phase = Math.random() * Math.PI * 2;
      } else if (type === "upward") {
        vy = 0;
        rangeY = stairGap * 0.7;
        phase = Math.random() * Math.PI * 2;
      }
      let newX = getPatternStairX(getWidth(), stairWidth);
      const stairIndex = Math.round((getHeight() - stairHeight - newY) / stairGap);
      let hasShoe = false, hasPill = false;
      if (stairIndex > 0 && stairIndex % 8 === 0 && Math.random() < 0.3) {
        if (shoeItemEnabled) {
          if (Math.random() < 0.5) {
            hasShoe = true;
          } else {
            hasPill = true;
          }
        }
      }
      stairs.push({x: newX, y: newY, width: stairWidth, height: stairHeight, type, vx, vy, baseX: newX, baseY: newY, rangeX, rangeY, phase, hasShoe, hasPill
        // æ–°å¢å½ˆç°§å¹³å°å‹•ç•«å±¬æ€§
        , ...(type === 'spring' ? {
          springState: 'normal', // 'normal' | 'compressed' | 'stretching'
          springAnimStart: 0,
          springAnimFrom: stairHeight,
          springAnimTo: stairHeight,
          springCurrentHeight: stairHeight
        } : {})
      });
      lastY = newY;
    }
  }
  
  // æ›´æ–°ç§»å‹•å¹³å°ä½ç½®ï¼ˆå—éŠæˆ²é€Ÿåº¦å½±éŸ¿ï¼‰
  const gameSpeedFactor = 1 + (gameSpeedMultiplier / 100);
  let t = performance.now() / 1000 * gameSpeedFactor;
  for (let s of stairs) {
    if (s.type === "horizontal") {
      s.x = s.baseX + Math.sin(t + s.phase) * s.rangeX;
    } else if (s.type === "vertical") {
      s.y = s.baseY + Math.sin(t + s.phase) * s.rangeY;
    } else if (s.type === "upward") {
      s.y = s.baseY + Math.sin(t + s.phase) * s.rangeY;
    }
    // å½ˆç°§å¹³å°å‹•ç•«ç‹€æ…‹
    if (s.type === 'spring') {
      if (s.springState === 'normal') {
        s.springCurrentHeight = s.height;
      } else if (s.springState === 'compressed') {
        s.springCurrentHeight = s.height / 2;
      } else if (s.springState === 'stretching') {
        const duration = 500; // ms
        const now = performance.now();
        const elapsed = now - s.springAnimStart;
        if (elapsed < duration) {
          // ç·šæ€§æ’å€¼å¾2å€é«˜åº¦å›åˆ°æ­£å¸¸é«˜åº¦
          const t = elapsed / duration;
          s.springCurrentHeight = s.springAnimFrom + (s.springAnimTo - s.springAnimFrom) * (1 - t);
        } else {
          s.springCurrentHeight = s.height;
          s.springState = 'normal';
        }
      }
    }
  }
}

function gameLoop() {
  if (paused) return;

  // --- ç§»é™¤éš¨æ©Ÿè·³éå¹€çš„æ…¢å‹•ä½œé‚è¼¯ ---

  // -- è¼¸å…¥ç‹€æ…‹è™•ç† (ç§»åˆ°è¿´åœˆå‰ç«¯ï¼Œç¢ºä¿å³æ™‚åæ‡‰) --
  const wantsToCharge = inputState.isPressed || inputState.spacebar;
  if (wantsToCharge && player.alive) {
    if (player.onStair && !player.charging) {
      // è™•ç†åœ¨åœ°é¢ä¸ŠæŒ‰ä¸‹æ™‚ç›´æ¥é–‹å§‹é›†æ°£
      startCharge();
      player.chargePending = false;
    } else if (!player.onStair) {
      // è™•ç†åœ¨ç©ºä¸­æŒ‰ä¸‹æ™‚ï¼Œè¨­å®š"ç­‰å¾…é›†æ°£"ç‹€æ…‹
      player.chargePending = true;
    }
  } else { // released
    if (player.charging) {
      releaseJump();
    }
    // åªè¦æ”¾é–‹ï¼Œå°±æ¸…é™¤ç­‰å¾…ç‹€æ…‹
    player.chargePending = false;
  }

  // æ¯å¹€éæ¸› jump buffer timer
  if (jumpBufferTimer > 0) {
    jumpBufferTimer -= 1/60;
    if (jumpBufferTimer < 0) jumpBufferTimer = 0;
  }

  ctx.clearRect(0, 0, getWidth(), getHeight());
  // èƒŒæ™¯ï¼ˆä¸ŠåŠéƒ¨ #3b0600 æ¼¸å±¤åˆ° #5a1b01ï¼‰
  let grad = ctx.createLinearGradient(0, 0, 0, getHeight());
  grad.addColorStop(0, "#3b0600");
  grad.addColorStop(1, "#5a1b01");
  ctx.fillStyle = grad;
  ctx.fillRect(0, 0, getWidth(), getHeight());
  
  drawStairs();
  if (!updatePlayer()) return;
  // é¡é ­å¹³æ»‘ç§»å‹•
  const cameraSpeed = 18; // æ¯å¹€æœ€å¤§ç§»å‹•åƒç´ 
  if (Math.abs(cameraOffsetY - cameraTargetOffsetY) > 1) {
    cameraOffsetY += (cameraTargetOffsetY - cameraOffsetY) * 0.08;
    // è‹¥å¾ˆæ¥è¿‘ç›®æ¨™å°±ç›´æ¥åˆ°ä½
    if (Math.abs(cameraOffsetY - cameraTargetOffsetY) < 1) cameraOffsetY = cameraTargetOffsetY;
  } else {
    cameraOffsetY = cameraTargetOffsetY;
  }
  // æ–°å¢ï¼šåªåœ¨ needScrollToStair æ™‚è¨­å®šç›®æ¨™é¡é ­
  if (needScrollToStair) {
    cameraTargetOffsetY = player.y + player.height - getHeight() / 2;
    needScrollToStair = false;
  }
  updateStairs();
  drawPlayer();
  drawHUD();
  ctx.strokeStyle = "#fff";
  ctx.lineWidth = 4;
  ctx.strokeRect(0, 0, getWidth(), getHeight());
  ctx.lineWidth = 1;

  // è“„åŠ›ä¸­æ¯å¹€å¢åŠ åŠ›é‡
  if (player && player.charging && player.onStair && !player.jumping) {
    // åŠ›é‡é‡ç½®é–‹å•Ÿæ™‚ï¼Œé›†æ°£é€Ÿåº¦è¼ƒæ…¢
    player.powerIncrement = powerAutoReset ? 2 : 4;
    if (powerAutoReset && player.power >= player.maxPower) {
      player.power = 0; // è‡ªå‹•é‡ç½®
    } else {
      player.power = Math.min(player.maxPower, player.power + player.powerIncrement);
    }
  }
  
  // æ ¹æ“šéŠæˆ²é€Ÿåº¦èª¿æ•´ä¸‹ä¸€å¹€çš„å»¶é²
  animationFrameId = requestAnimationFrame(gameLoop);
}

function showGameOverModal(score, isNewRecord) {
  const modal = document.getElementById('gameover-modal');
  const msg = document.getElementById('gameover-msg');
  msg.innerHTML = `éŠæˆ²çµæŸï¼<br>æ¨“å±¤: <b style="color:yellow;">${score}</b>${isNewRecord ? '<br><span style="color:#0f0;">æ–°ç´€éŒ„ï¼</span>' : ''}`;
  modal.style.display = 'flex';
}

function startCharge() {
    if (player && player.onStair && !player.charging && player.alive) {
        player.charging = true;
        playSfx(sfxCharge);
        return true;
    }
    return false;
}

function releaseJump() {
  let didJump = false;
  if (player && player.charging && player.alive) {
    if (player.onStair) {
      const powerRatio = player.power / player.maxPower;
      let maxJumpHeight = 7.5 * player.height;
      if (shoeBuffActive) maxJumpHeight *= 1.5;
      if (pillBuffActive) maxJumpHeight *= 2;
      
      // è¨ˆç®—éŠæˆ²é€Ÿåº¦å€æ•¸
      const gameSpeedFactor = 1 + (gameSpeedMultiplier / 100);
      
      // èª¿æ•´é‡åŠ›ä»¥ä¿æŒè·³èºé«˜åº¦ä¸è®Š
      const adjustedGravity = player.gravity * gameSpeedFactor;
      const maxVy = -Math.sqrt(2 * adjustedGravity * maxJumpHeight);
      player.vy = player.jumpPower + (maxVy - player.jumpPower) * powerRatio;
      const onSpring = player.landedOn && player.landedOn.type === 'spring';
      if (onSpring) {
        // å½ˆç°§å¹³å°æ‹‰ä¼¸å‹•ç•«
        if (player.landedOn.springState === 'compressed') {
          player.landedOn.springState = 'stretching';
          player.landedOn.springAnimStart = performance.now();
          player.landedOn.springAnimFrom = player.landedOn.height / 2;
          player.landedOn.springAnimTo = player.landedOn.height * 2;
        }
        player.vy *= 1.5; // å¾å½ˆç°§å¹³å°è·³å¾—æ›´é«˜
        playSfx(sfxSpringJump);
      } else {
        playSfx(sfxJump);
      }
      player.jumping = true;
      player.onStair = false;
      player.landedOn = null;
      player.lastJumpTime = performance.now() / 1000;
      didJump = true;
    }
    player.charging = false;
    player.power = 0;
  }
  // ç„¡è«–æœ‰ç„¡é›†æ°£ï¼Œåªè¦åœ¨ç©ºä¸­é‡‹æ”¾éƒ½è¨­ jump buffer
  if (player && !player.onStair && player.alive) {
    jumpBufferTimer = JUMP_BUFFER_TIME;
  }
  return didJump;
}

document.getElementById('restart-btn').addEventListener('click', () => {
  document.getElementById('gameover-modal').style.display = 'none';
  initGame();
});

window.addEventListener('keydown', function(e) {
  const modal = document.getElementById('gameover-modal');
  if (modal.style.display === 'flex' && (e.key === 'Enter' || e.keyCode === 13)) {
    modal.style.display = 'none';
    initGame();
    e.preventDefault();
    return;
  }
  if ((e.key === ' ' || e.key === 'Spacebar')) {
    inputState.spacebar = true;
    e.preventDefault();
  }
});

window.addEventListener('keyup', function(e) {
  if ((e.key === ' ' || e.key === 'Spacebar')) {
    inputState.spacebar = false;
    e.preventDefault();
  }
});

window.addEventListener('mousedown', function(e) {
  // å¦‚æœé»æ“Šçš„æ˜¯æŒ‰éˆ•ï¼Œå‰‡ä¸è§¸ç™¼é›†æ°£
  if (e.target.tagName === 'BUTTON') return;
  inputState.isPressed = true;
  e.preventDefault(); // é˜²æ­¢é¸å–æ–‡å­—æˆ–å…¶ä»–é è¨­è¡Œç‚º
});
window.addEventListener('mouseup', function(e) {
  inputState.isPressed = false;
});
window.addEventListener('touchstart', function(e) {
  // å¦‚æœè§¸æ§çš„æ˜¯æŒ‰éˆ•ï¼Œå‰‡ä¸è§¸ç™¼é›†æ°£
  if (e.target.tagName === 'BUTTON') return;
  inputState.isPressed = true;
  e.preventDefault(); // é˜²æ­¢æ²å‹•æˆ–è§¸ç™¼æ»‘é¼ äº‹ä»¶
});
window.addEventListener('touchend', function(e) {
  inputState.isPressed = false;
});

window.addEventListener('DOMContentLoaded', function() {
  const sfxToggle = document.getElementById('sfx-toggle');
  const bgmToggle = document.getElementById('bgm-toggle');
  const pauseToggle = document.getElementById('pause-toggle');
  const settingsToggle = document.getElementById('settings-toggle');
  const helpToggle = document.getElementById('help-toggle');
  const helpModal = document.getElementById('help-modal');
  const helpCloseBtn = document.getElementById('help-close-btn');
  // é—œæ–¼å½ˆçª—
  const aboutToggle = document.getElementById('about-toggle');
  const aboutModal = document.getElementById('about-modal');
  const aboutCloseBtn = document.getElementById('about-close-btn');
  // è¨­å®šå½ˆçª—
  const settingsModal = document.getElementById('settings-modal');
  const settingsCloseBtn = document.getElementById('settings-close-btn');
  const settingsPowerReset = document.getElementById('settings-power-reset');
  const settingsWalkSlow = document.getElementById('settings-walk-slow');
  const settingsWalkNormal = document.getElementById('settings-walk-normal');
  const settingsWalkFast = document.getElementById('settings-walk-fast');
  const settingsShoeItem = document.getElementById('settings-shoe-item');
  const settingsSpeedDecrease = document.getElementById('speed-decrease');
  const settingsSpeedIncrease = document.getElementById('speed-increase');
  const speedDisplay = document.getElementById('speed-display');

  if (sfxToggle) sfxToggle.blur();
  if (bgmToggle) bgmToggle.blur();
  if (pauseToggle) pauseToggle.blur();
  if (settingsToggle) {
    settingsToggle.addEventListener('click', function() {
      // åˆå§‹åŒ–è¨­å®šå½ˆçª—å…§å®¹
      settingsPowerReset.textContent = powerAutoReset ? 'ON' : 'OFF';
      settingsShoeItem.textContent = shoeItemEnabled ? 'ON' : 'OFF';
      
      // æ›´æ–°è¡Œèµ°é€Ÿåº¦æŒ‰éˆ•ç‹€æ…‹
      updateWalkSpeedButtons();
      
      // æ›´æ–°é€Ÿåº¦æ»‘æ¡¿ç‹€æ…‹
      updateSpeedSlider();
      
      settingsModal.style.display = 'flex';
    });
  }
  if (settingsCloseBtn) {
    settingsCloseBtn.addEventListener('click', function() {
      settingsModal.style.display = 'none';
    });
  }
  if (settingsPowerReset) {
    settingsPowerReset.addEventListener('click', function() {
      powerAutoReset = !powerAutoReset;
      settingsPowerReset.textContent = powerAutoReset ? 'ON' : 'OFF';
      drawHUD();
    });
  }
  
  // è¡Œèµ°é€Ÿåº¦æŒ‰éˆ•äº‹ä»¶è™•ç†
  if (settingsWalkSlow) {
    settingsWalkSlow.addEventListener('click', function() {
      walkSpeedMode = 'slow';
      if (player) player.vx = getFinalWalkSpeed();
      updateWalkSpeedButtons();
      drawHUD();
    });
  }
  if (settingsWalkNormal) {
    settingsWalkNormal.addEventListener('click', function() {
      walkSpeedMode = 'normal';
      if (player) player.vx = getFinalWalkSpeed();
      updateWalkSpeedButtons();
      drawHUD();
    });
  }
  if (settingsWalkFast) {
    settingsWalkFast.addEventListener('click', function() {
      walkSpeedMode = 'fast';
      if (player) player.vx = getFinalWalkSpeed();
      updateWalkSpeedButtons();
      drawHUD();
    });
  }
  
  function updateSpeedDisplay() {
    if (speedDisplay) speedDisplay.textContent = gameSpeedMultiplier;
  }
  updateSpeedDisplay();

  // æŒ‰ä½æŒ‰éˆ•æŒçºŒèª¿æ•´çš„è®Šæ•¸
  let speedDecreaseInterval = null;
  let speedIncreaseInterval = null;

  if (settingsSpeedDecrease) {
    settingsSpeedDecrease.addEventListener('mousedown', function() {
      // ç«‹å³èª¿æ•´ä¸€æ¬¡
      gameSpeedMultiplier -= 5;
      updateSpeedSlider();
      drawHUD();
      
      // é–‹å§‹æŒçºŒèª¿æ•´
      speedDecreaseInterval = setInterval(() => {
        gameSpeedMultiplier -= 2;
        updateSpeedSlider();
        drawHUD();
      }, 100); // æ¯100msèª¿æ•´ä¸€æ¬¡
    });
    
    settingsSpeedDecrease.addEventListener('mouseup', function() {
      if (speedDecreaseInterval) {
        clearInterval(speedDecreaseInterval);
        speedDecreaseInterval = null;
      }
    });
    
    settingsSpeedDecrease.addEventListener('mouseleave', function() {
      if (speedDecreaseInterval) {
        clearInterval(speedDecreaseInterval);
        speedDecreaseInterval = null;
      }
    });
    
    // è§¸æ§è¨­å‚™æ”¯æ´
    settingsSpeedDecrease.addEventListener('touchstart', function(e) {
      e.preventDefault();
      // ç«‹å³èª¿æ•´ä¸€æ¬¡
      gameSpeedMultiplier -= 5;
      updateSpeedSlider();
      drawHUD();
      
      // é–‹å§‹æŒçºŒèª¿æ•´
      speedDecreaseInterval = setInterval(() => {
        gameSpeedMultiplier -= 2;
        updateSpeedSlider();
        drawHUD();
      }, 100);
    });
    
    settingsSpeedDecrease.addEventListener('touchend', function() {
      if (speedDecreaseInterval) {
        clearInterval(speedDecreaseInterval);
        speedDecreaseInterval = null;
      }
    });
  }
  
  if (settingsSpeedIncrease) {
    settingsSpeedIncrease.addEventListener('mousedown', function() {
      // ç«‹å³èª¿æ•´ä¸€æ¬¡
      gameSpeedMultiplier += 5;
      updateSpeedSlider();
      drawHUD();
      
      // é–‹å§‹æŒçºŒèª¿æ•´
      speedIncreaseInterval = setInterval(() => {
        gameSpeedMultiplier += 2;
        updateSpeedSlider();
        drawHUD();
      }, 100); // æ¯100msèª¿æ•´ä¸€æ¬¡
    });
    
    settingsSpeedIncrease.addEventListener('mouseup', function() {
      if (speedIncreaseInterval) {
        clearInterval(speedIncreaseInterval);
        speedIncreaseInterval = null;
      }
    });
    
    settingsSpeedIncrease.addEventListener('mouseleave', function() {
      if (speedIncreaseInterval) {
        clearInterval(speedIncreaseInterval);
        speedIncreaseInterval = null;
      }
    });
    
    // è§¸æ§è¨­å‚™æ”¯æ´
    settingsSpeedIncrease.addEventListener('touchstart', function(e) {
      e.preventDefault();
      // ç«‹å³èª¿æ•´ä¸€æ¬¡
      gameSpeedMultiplier += 5;
      updateSpeedSlider();
      drawHUD();
      
      // é–‹å§‹æŒçºŒèª¿æ•´
      speedIncreaseInterval = setInterval(() => {
        gameSpeedMultiplier += 2;
        updateSpeedSlider();
        drawHUD();
      }, 100);
    });
    
    settingsSpeedIncrease.addEventListener('touchend', function() {
      if (speedIncreaseInterval) {
        clearInterval(speedIncreaseInterval);
        speedIncreaseInterval = null;
      }
    });
  }
  
  if (settingsShoeItem) {
    settingsShoeItem.addEventListener('click', function() {
      shoeItemEnabled = !shoeItemEnabled;
      settingsShoeItem.textContent = shoeItemEnabled ? 'ON' : 'OFF';
      drawHUD();
    });
  }
  if (sfxToggle) {
    sfxToggle.addEventListener('click', function() {
      sfxMuted = !sfxMuted;
      sfxJump.muted = sfxMuted;
      sfxDead.muted = sfxMuted;
      sfxLand.muted = sfxMuted;
      sfxSpringJump.muted = sfxMuted;
      sfxCharge.muted = sfxMuted;
      drawHUD();
    });
  }
  if (bgmToggle) {
    bgmToggle.addEventListener('click', function() {
      bgmMuted = !bgmMuted;
      bgm.muted = bgmMuted;
      if (bgmMuted) {
        bgm.pause();
      } else {
        try { bgm.play(); } catch (e) {}
      }
      drawHUD();
    });
  }
  if (pauseToggle) {
    pauseToggle.addEventListener('click', function() {
      paused = !paused;
      pauseToggle.textContent = paused ? 'â–¶ï¸ ç¹¼çºŒ' : 'â¸ï¸ æš«åœ';
      if (!paused) gameLoop();
    });
  }
  if (helpToggle) {
    helpToggle.addEventListener('click', function() {
      helpModal.style.display = 'flex';
    });
  }
  if (helpCloseBtn) {
    helpCloseBtn.addEventListener('click', function() {
      helpModal.style.display = 'none';
    });
  }
  if (aboutToggle) {
    aboutToggle.addEventListener('click', function() {
      aboutModal.style.display = 'flex';
    });
  }
  if (aboutCloseBtn) {
    aboutCloseBtn.addEventListener('click', function() {
      aboutModal.style.display = 'none';
    });
  }
});

function handleFirstInteraction() {
  if (!firstInteraction) {
    firstInteraction = true;
    sfxJump.muted = sfxMuted;
    sfxDead.muted = sfxMuted;
    sfxLand.muted = sfxMuted;
    sfxSpringJump.muted = sfxMuted;
    sfxCharge.muted = sfxMuted;
    bgm.muted = bgmMuted;
    tryPlayBgm();
  }
}

// æ›´æ–°è¡Œèµ°é€Ÿåº¦æŒ‰éˆ•ç‹€æ…‹
function updateWalkSpeedButtons() {
  const slowBtn = document.getElementById('settings-walk-slow');
  const normalBtn = document.getElementById('settings-walk-normal');
  const fastBtn = document.getElementById('settings-walk-fast');
  
  // é‡ç½®æ‰€æœ‰æŒ‰éˆ•æ¨£å¼
  [slowBtn, normalBtn, fastBtn].forEach(btn => {
    if (btn) {
      btn.style.background = '#333';
      btn.style.color = '#fff';
      btn.style.border = '1px solid #666';
    }
  });
  
  // æ ¹æ“šç•¶å‰æ¨¡å¼åç™½å°æ‡‰æŒ‰éˆ•
  let activeBtn = null;
  switch (walkSpeedMode) {
    case 'slow':
      activeBtn = slowBtn;
      break;
    case 'normal':
      activeBtn = normalBtn;
      break;
    case 'fast':
      activeBtn = fastBtn;
      break;
  }
  
  if (activeBtn) {
    activeBtn.style.background = '#ffe600';
    activeBtn.style.color = '#222';
    activeBtn.style.border = '1px solid #ffe600';
  }
}

// æ›´æ–°é€Ÿåº¦æŒ‰éˆ•è¦–è¦ºæ•ˆæœ
function updateSpeedSlider() {
  // æ›´æ–°é€Ÿåº¦é¡¯ç¤º
  const speedDisplay = document.getElementById('speed-display');
  if (speedDisplay) {
    speedDisplay.textContent = gameSpeedMultiplier;
  }
  
  // æ›´æ–°ç©å®¶é€Ÿåº¦ï¼ˆå³æ™‚åæ˜ éŠæˆ²é€Ÿåº¦è®ŠåŒ–ï¼‰
  if (player) {
    player.vx = getFinalWalkSpeed();
  }
}

window.addEventListener('click', handleFirstInteraction, { once: true });
window.addEventListener('touchstart', handleFirstInteraction, { once: true });

initGame();
</script>
</body>
</html> 
